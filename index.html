<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>人的控除アプリ r4（基・配・特・所 転記シート対応）</title>
<style>
  :root{--ink:#111;--muted:#6b7280;--bg:#f8fafc;--accent:#0ea5e9;--border:#e5e7eb}
  html,body{margin:0;padding:0;color:var(--ink);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;background:#fff}
  header{position:sticky;top:0;background:#fff;z-index:5;border-bottom:1px solid var(--border)}
  header .bar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 14px}
  header h1{font-size:16px;margin:0}
  main{display:grid;grid-template-columns: 340px 1fr;gap:14px;padding:14px}
  .panel{border:1px solid var(--border);border-radius:12px;background:#fff}
  .panel h2{font-size:15px;margin:0;padding:12px 14px;border-bottom:1px solid var(--border)}
  .panel .content{padding:12px 14px}
  .row{display:grid;grid-template-columns: 1fr 1fr;gap:8px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:12px;color:var(--muted)}
  .field input, .field select{padding:8px;border:1px solid var(--border);border-radius:8px;font-size:14px}
  .muted{color:var(--muted)}
  button{appearance:none;border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
  button.primary{background:var(--accent);color:#fff;border-color:transparent}
  .members{display:flex;flex-direction:column;gap:10px}
  .member{border:1px dashed var(--border);border-radius:10px;padding:10px}
  .member header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .member h3{font-size:14px;margin:0}
  .member .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .hint{font-size:12px;color:var(--muted)}

  /* 結果 */
  .results{display:grid;grid-template-columns: repeat(2, minmax(280px, 1fr)); gap:12px}
  .card{border:1px solid var(--border);border-radius:12px;padding:12px}
  .card h3{margin:0 0 6px 0;font-size:14px}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border:1px solid var(--border);padding:6px 8px;text-align:left}

  /* 転記シート（A4横・様式準拠レイアウト） */
  .sheet{--gap:8px;background:#fff;border:2px solid #000;border-radius:0;padding:8px;display:grid;gap:8px}
  .sheet .title{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #000;padding-bottom:6px}
  .sheet h2{font-size:16px;margin:0}
  .sheet .topline{display:grid;grid-template-columns:2fr 2fr 1fr;gap:8px}
  .box{border:1px solid #000;padding:8px}
  .box h4{margin:0 0 6px 0;font-size:13px}
  .kv{display:grid;grid-template-columns: 240px 1fr;gap:6px}
  .kv div{display:flex;gap:6px;align-items:center}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .subtle{color:#444}

  .grid-2{display:grid;grid-template-columns: 1fr 1fr;gap:8px}
  .grid-3{display:grid;grid-template-columns: repeat(3,1fr);gap:8px}

  .badge{font-size:11px;border:1px solid #000;padding:2px 6px;display:inline-block}
  .right{justify-self:end}

  .print-bar{display:flex;gap:8px;align-items:center}
  @media print{
    @page{size:A4 landscape;margin:10mm}
    header, .no-print{display:none !important}
    main{display:block;padding:0}
    .sheet{border:none}
  }
</style>
</head>
<body>
  <header>
    <div class="bar">
      <h1>人的控除アプリ r4（基・配・特・所 転記シート対応）</h1>
      <div class="print-bar no-print">
        <button onclick="recalc()">再計算</button>
        <button class="primary" onclick="window.print()">A4横で印刷</button>
      </div>
    </div>
  </header>

  <main>
    <!-- 左：入力 -->
    <section class="panel">
      <h2>① 世帯・本人情報</h2>
      <div class="content">
        <div class="field"><label>給与の支払者（勤務先名）</label><input id="employer" placeholder="○○株式会社"/></div>
        <div class="field"><label>あなたの氏名（本人）</label><input id="youName" placeholder="山田 太郎"/></div>
        <div class="row">
          <div class="field"><label>あなたのふりがな</label><input id="youKana" placeholder="ヤマダ タロウ"/></div>
          <div class="field"><label>あなたの住所</label><input id="youAddr" placeholder="東京都○○区…"/></div>
        </div>
        <div class="row">
          <div class="field"><label>あなたの生年月日</label><input id="youDOB" type="date"/></div>
          <div class="field"><label>あなたの給与収入（見積）</label><input id="youSalary" type="number" min="0" step="1000" placeholder="例 5500000"/></div>
        </div>
        <div class="row">
          <div class="field"><label>あなたの給与以外の所得（見積）</label><input id="youOther" type="number" min="0" step="1000" value="0"/></div>
          <div class="field"><label>障害者区分</label>
            <select id="youDis">
              <option value="none">該当なし</option>
              <option value="disabled">障害者</option>
              <option value="tokubetsu">特別障害者</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>② 家族情報（配偶者・扶養親族等）</h2>
      <div class="content">
        <div class="members" id="members"></div>
        <div class="no-print" style="margin-top:8px;display:flex;gap:8px">
          <button onclick="addMember('配偶者')">配偶者を追加</button>
          <button onclick="addMember('子')">子を追加</button>
          <button onclick="addMember('その他親族')">その他親族を追加</button>
        </div>
        <p class="hint">※ 給与収入を入れると、自動的に合計所得金額（簡易計算）へ変換します（給与所得控除の最低保障額 <b>65万円</b> を反映）。</p>
      </div>
    </section>

    <!-- 右：計算と転記シート -->
    <section class="panel" style="grid-column: 1 / -1">
      <h2>③ 計算結果</h2>
      <div class="content">
        <div class="results" id="results"></div>
      </div>
    </section>

    <section class="panel" style="grid-column: 1 / -1">
      <h2>④ 転記シート（令和7年分「基・配・特・所」様式に合わせた下書き）</h2>
      <div class="content">
        <div class="sheet" id="sheet">
          <!-- JSが埋め込み -->
        </div>
        <p class="hint">
          ・レイアウトは <span class="mono">2025bun_06.pdf</span> の「給与所得者の基礎控除申告書／配偶者控除等申告書／特定親族特別控除申告書／所得金額調整控除申告書」見本に沿った下書きです（A4横）。<br/>
          ・実際の様式には個人番号欄や押印欄等があります。本シートは下書き補助です。最終記入は国税庁様式をご確認ください。
        </p>
      </div>
    </section>
  </main>

<script>
// ====== データモデル ======
const el = (sel) => document.querySelector(sel);
let members = []; // household except "本人"（本人は個別入力欄）

function addMember(kind){
  const id = crypto.randomUUID();
  const m = { id, kind, name:"", kana:"", dob:"", salary:0, other:0, disabled:"none", cohabit:true };
  members.push(m);
  renderMembers();
  recalc();
}

function removeMember(id){
  members = members.filter(m=>m.id!==id);
  renderMembers();
  recalc();
}

function renderMembers(){
  const wrap = el('#members');
  wrap.innerHTML = '';
  members.forEach((m,idx)=>{
    const div = document.createElement('div');
    div.className = 'member';
    div.innerHTML = `
      <header>
        <h3>${idx+1}. ${m.kind}</h3>
        <button class="no-print" onclick="removeMember('${m.id}')">削除</button>
      </header>
      <div class="grid">
        <div class="field"><label>氏名</label><input value="${m.name}" oninput="onEdit('${m.id}','name',this.value)"/></div>
        <div class="field"><label>ふりがな</label><input value="${m.kana}" oninput="onEdit('${m.id}','kana',this.value)"/></div>
        <div class="field"><label>生年月日</label><input type="date" value="${m.dob}" oninput="onEdit('${m.id}','dob',this.value)"/></div>
        <div class="field"><label>給与収入（見積）</label><input type="number" min="0" step="1000" value="${m.salary}" oninput="onEdit('${m.id}','salary',Number(this.value||0))"/></div>
        <div class="field"><label>給与以外の所得（見積）</label><input type="number" min="0" step="1000" value="${m.other}" oninput="onEdit('${m.id}','other',Number(this.value||0))"/></div>
        <div class="field"><label>障害者区分</label>
          <select oninput="onEdit('${m.id}','disabled',this.value)">
            <option ${m.disabled==='none'?'selected':''} value="none">該当なし</option>
            <option ${m.disabled==='disabled'?'selected':''} value="disabled">障害者</option>
            <option ${m.disabled==='tokubetsu'?'selected':''} value="tokubetsu">特別障害者</option>
          </select>
        </div>
        <div class="field"><label>同居（世帯内）</label>
          <select oninput="onEdit('${m.id}','cohabit',this.value==='true')">
            <option value="true" ${m.cohabit? 'selected':''}>はい</option>
            <option value="false" ${!m.cohabit? 'selected':''}>いいえ</option>
          </select>
        </div>
      </div>
    `;
    wrap.appendChild(div);
  })
}

function onEdit(id, key, val){
  const m = members.find(x=>x.id===id);
  if(!m) return;
  m[key] = val;
  recalc();
}

// ====== 計算ユーティリティ ======
function salaryToIncome(s){ // 簡易：最低保障 65万円（R7改正）。負の場合は0
  s = Number(s||0);
  const income = Math.max(0, s - 650000);
  return Math.round(income);
}

function ageAt(dob){ if(!dob) return null; const dt=new Date(dob); if(isNaN(dt)) return null; const today=new Date(); let age=today.getFullYear()-dt.getFullYear(); const m=today.getMonth()-dt.getMonth(); if(m<0 || (m===0 && today.getDate()<dt.getDate())) age--; return age; }

function agiOf(person){ // 合計所得金額（簡易）
  return salaryToIncome(person.salary) + Number(person.other||0);
}

// 基礎控除（R7改正後の加算後額）
function basicDeductionR7(agi){
  if(agi<=1320000) return 950000; // 95万
  if(agi<=3360000) return 880000; // 88万
  if(agi<=4890000) return 680000; // 68万
  if(agi<=6550000) return 630000; // 63万
  if(agi<=23500000) return 580000; // 58万
  // 以降は居住者加算なしの旧段階（PDFに表示あり）。安全側で48/32/16を採用。
  if(agi<=24000000) return 480000;
  if(agi<=24500000) return 320000;
  return 160000;
}

// 区分Ⅰ（本人）…従来どおり A:900万以下 / B:900超〜950以下 / C:950超〜1000以下
function kubunI(agi){
  if(agi<=9000000) return 'A';
  if(agi<=9500000) return 'B';
  if(agi<=10000000) return 'C';
  return '-';
}

// 配偶者控除 or 配偶者特別控除（R7の閾値反映）
function spouseDeductionR7(taxpayerAgi, spouseAgi, spouseAge){
  if(spouseAgi>1330000 || taxpayerAgi>10000000) return {type:'対象外', amount:0, kubunII:'-'};
  // 区分Ⅱ（参考：zeimo 等の解説に基づく）
  let kubunII;
  if(spouseAgi<=580000){ kubunII = (spouseAge>=70)? '①' : '②'; }
  else if(spouseAgi<=950000){ kubunII = '③'; }
  else { kubunII = '④'; }

  // 控除額表（本人区分×配偶者区分）を数値化（R7・一般配偶者）
  // 便宜上、税額表の代表値を使用（実務は様式表に従ってください）。
  const A = { '①':380000, '②':380000, '③':380000, '④':260000 };
  const B = { '①':260000, '②':260000, '③':260000, '④':130000 };
  const C = { '①':130000, '②':130000, '③':130000, '④':  0   };
  const row = (taxpayerAgi<=9000000)?A : (taxpayerAgi<=9500000?B:C);

  // 区分Ⅱ③・④ のうち配偶者特別控除は所得階層により逓減（下表を近似）
  let base = row[kubunII]||0;
  if(kubunII==='③'){
    // 58超95以下：最大 38/26/13 を維持
    base = row['③'];
  }else if(kubunII==='④'){
    // 95超133以下：逓減。おおむね 26→0（A帯）/13→0（B帯）/0（C帯）
    // ここでは線形近似（95〜133で0へ）。
    const span = 1330000 - 950000;
    const t = Math.max(0, Math.min(1, (spouseAgi-950000)/span));
    base = Math.round(row['④'] * (1 - t));
  }
  const type = (kubunII==='①' || kubunII==='②')? '配偶者控除' : '配偶者特別控除';
  return {type, amount: base, kubunII};
}

// 扶養控除（16歳以上の扶養親族、老人/同居老親等/特定扶養）※ざっくり
function fuyouDeduction(member){
  const age = ageAt(member.dob);
  const agi = agiOf(member);
  if(agi>580000) return 0; // R7改正
  if(age===null) return 0;
  if(age>=70){ return member.cohabit? 580000 : 480000; }
  if(age>=19 && age<23){ return 630000; } // 特定扶養親族（R7でも据置）
  if(age>=16){ return 380000; }
  return 0;
}

// 特定親族特別控除（R7新設）…財務省大綱の表に基づく
function tokuteiShinzokuTokubetsu(member){
  const age = ageAt(member.dob);
  const agi = agiOf(member);
  if(!(age>=19 && age<23)) return 0;
  if(agi<=580000) return 0; // 58万円以下は従来の特定扶養へ（控除は扶養控除で対応）
  if(agi<=850000) return 630000;
  if(agi<=900000) return 610000;
  if(agi<=950000) return 510000;
  if(agi<=1000000) return 410000;
  if(agi<=1050000) return 310000;
  if(agi<=1100000) return 210000;
  if(agi<=1150000) return 110000;
  if(agi<=1200000) return  60000;
  if(agi<=1230000) return  30000;
  return 0;
}

// 所得金額調整控除（年収 > 850万で要件があれば）…簡易
function shotokuChousei(taxpayer, family){
  const salary = Number(taxpayer.salary||0);
  if(salary<=8500000) return {eligible:false, reason:"要件外", amount:0};
  const hasUnder23 = family.some(m=>{const a=ageAt(m.dob); return a!==null && a<23;});
  const hasTokubetsuDisabled = (taxpayer.disabled==='tokubetsu') || family.some(m=>m.disabled==='tokubetsu');
  if(!(hasUnder23 || hasTokubetsuDisabled)) return {eligible:false, reason:"該当者なし", amount:0};
  // 概算：最大15万円の範囲。ここでは 10万円とする（実務は別計算）。
  return {eligible:true, reason: hasUnder23?"23歳未満の扶養親族あり":"特別障害者あり", amount:100000};
}

function fmt(n){ return (n||0).toLocaleString('ja-JP'); }

// ====== 集計 ======
function recalc(){
  // 入力
  const you = {
    name: el('#youName').value.trim(), kana: el('#youKana').value.trim(), addr: el('#youAddr').value.trim(), dob: el('#youDOB').value,
    salary: Number(el('#youSalary').value||0), other: Number(el('#youOther').value||0), disabled: el('#youDis').value
  };
  const employer = el('#employer').value.trim();

  const youAGI = agiOf(you);
  const youBasic = basicDeductionR7(youAGI);
  const kubun1 = kubunI(youAGI);

  // 配偶者（1人想定）
  const spouse = members.find(m=>m.kind==='配偶者');
  let spouseInfo = {type:'対象外', amount:0, kubunII:'-', agi:0, age:null, name:'', kana:''};
  if(spouse){
    spouseInfo = spouseDeductionR7(youAGI, agiOf(spouse), ageAt(spouse.dob));
    spouseInfo.agi = agiOf(spouse);
    spouseInfo.age = ageAt(spouse.dob);
    spouseInfo.name = spouse.name; spouseInfo.kana = spouse.kana;
  }

  // 扶養控除合計
  const dependents = members.filter(m=>m.kind!=='配偶者');
  const fuyouRows = dependents.map(m=>({m, age:ageAt(m.dob), agi:agiOf(m), fuyou:fuyouDeduction(m), tokutei:tokuteiShinzokuTokubetsu(m)}));
  const fuyouTotal = fuyouRows.reduce((a,r)=>a+r.fuyou,0);
  const tokuteiRows = fuyouRows.filter(r=>r.tokutei>0);
  const tokuteiTotal = tokuteiRows.reduce((a,r)=>a+r.tokutei,0);

  const chousei = shotokuChousei(you, members);

  // 右上カード
  const results = el('#results');
  results.innerHTML = '';
  const card1 = document.createElement('div');
  card1.className = 'card';
  card1.innerHTML = `<h3>本人の合計所得見積：<b class="mono">¥${fmt(youAGI)}</b></h3>
    <div class="muted">基礎控除：<b>¥${fmt(youBasic)}</b>（区分Ⅰ：${kubun1}）</div>`;
  const card2 = document.createElement('div');
  card2.className='card';
  card2.innerHTML = `<h3>配偶者控除等：</h3>
    <div>区分Ⅱ：${spouseInfo.kubunII}／種類：${spouseInfo.type}／控除額：<b>¥${fmt(spouseInfo.amount)}</b></div>`;
  const card3 = document.createElement('div'); card3.className='card';
  card3.innerHTML = `<h3>扶養控除合計：<b>¥${fmt(fuyouTotal)}</b></h3>
    <table class="table"><thead><tr><th>氏名</th><th>年齢</th><th>合計所得</th><th>区分</th><th>控除額</th></tr></thead><tbody>
      ${fuyouRows.filter(r=>r.fuyou>0).map(r=>`<tr><td>${r.m.name||'-'}</td><td>${r.age??'-'}</td><td class="mono">¥${fmt(r.agi)}</td><td>${(r.age>=70?(r.m.cohabit?'同居老親等':'老人'): (r.age>=19&&r.age<23?'特定扶養':'一般'))||'-'}</td><td class="mono">¥${fmt(r.fuyou)}</td></tr>`).join('')||'<tr><td colspan="5">—</td></tr>'}
    </tbody></table>`;
  const card4 = document.createElement('div'); card4.className='card';
  card4.innerHTML = `<h3>特定親族特別控除：<b>¥${fmt(tokuteiTotal)}</b></h3>
  <table class="table"><thead><tr><th>氏名</th><th>年齢</th><th>合計所得</th><th>控除額</th></tr></thead><tbody>
    ${tokuteiRows.map(r=>`<tr><td>${r.m.name||'-'}</td><td>${r.age??'-'}</td><td class="mono">¥${fmt(r.agi)}</td><td class="mono">¥${fmt(r.tokutei)}</td></tr>`).join('')||'<tr><td colspan="4">—</td></tr>'}
  </tbody></table>`;
  results.append(card1, card2, card3, card4);

  // ===== 転記シート描画 =====
  const sheet = el('#sheet');
  sheet.innerHTML = '';

  // タイトル／上段
  const title = document.createElement('div');
  title.className = 'title';
  title.innerHTML = `<h2>令和7年分  基礎控除・配偶者控除等・特定親族特別控除・所得金額調整控除（下書き）</h2>
  <div class="subtle">勤務先：${escapeHtml(employer)||'（未入力）'}</div>`;
  sheet.appendChild(title);

  const top = document.createElement('div');
  top.className='topline';
  top.innerHTML = `
    <div class="box">
      <h4>あなたの情報（氏名・住所等）</h4>
      <div class="kv">
        <div>氏名（フリガナ）</div><div><b>${escapeHtml(you.name)||'—'}</b>（${escapeHtml(you.kana)||'—'}）</div>
        <div>住所</div><div>${escapeHtml(you.addr)||'—'}</div>
        <div>生年月日</div><div>${you.dob||'—'}</div>
        <div>本人の合計所得見積額</div><div class="mono">¥${fmt(youAGI)}</div>
      </div>
    </div>
    <div class="box">
      <h4>配偶者の情報（配偶者控除等申告書）</h4>
      <div class="kv">
        <div>配偶者氏名（フリガナ）</div><div><b>${escapeHtml(spouse?.name)||'—'}</b>（${escapeHtml(spouse?.kana)||'—'}）</div>
        <div>配偶者生年月日</div><div>${spouse?.dob||'—'}（年齢：${spouseInfo.age??'—'}）</div>
        <div>配偶者の合計所得見積額</div><div class="mono">¥${fmt(spouseInfo.agi)||'0'}</div>
      </div>
    </div>
    <div class="box">
      <h4>チェック</h4>
      <div class="kv">
        <div>本人 区分Ⅰ</div><div class="mono">${kubun1}</div>
        <div>配偶者 区分Ⅱ</div><div class="mono">${spouseInfo.kubunII}</div>
        <div>所得金額調整控除</div><div>${chousei.eligible?('適用（理由：'+chousei.reason+'）'):'—'}</div>
      </div>
    </div>
  `;
  sheet.appendChild(top);

  // 4つの申告書ボックス
  const blocks = document.createElement('div');
  blocks.className='grid-2';

  // 基礎控除
  const b1 = document.createElement('div');
  b1.className='box';
  b1.innerHTML = `
    <h4>◆ 給与所得者の基礎控除申告書</h4>
    <div class="kv">
      <div>本年中の合計所得金額の見積額（①+②）</div><div class="mono">¥${fmt(youAGI)}</div>
      <div>判定 → 区分Ⅰ</div><div class="mono">${kubun1}</div>
      <div>基礎控除の額</div><div class="mono"><b>¥${fmt(youBasic)}</b></div>
    </div>
  `;

  // 配偶者控除等
  const b2 = document.createElement('div');
  b2.className='box';
  b2.innerHTML = `
    <h4>◆ 給与所得者の配偶者控除等申告書</h4>
    <div class="kv">
      <div>配偶者の合計所得金額の見積額（①+②）</div><div class="mono">¥${fmt(spouseInfo.agi)}</div>
      <div>区分Ⅱ（①〜④）</div><div class="mono">${spouseInfo.kubunII}</div>
      <div>控除額の計算 → 種類</div><div>${spouseInfo.type}</div>
      <div>配偶者控除／配偶者特別控除の額</div><div class="mono"><b>¥${fmt(spouseInfo.amount)}</b></div>
    </div>
  `;

  // 特定親族特別控除
  const b3 = document.createElement('div');
  b3.className='box';
  b3.innerHTML = `
    <h4>◆ 給与所得者の特定親族特別控除申告書</h4>
    <table class="table">
      <thead><tr><th>特定親族の氏名</th><th>年齢</th><th>合計所得見積額</th><th>特定親族特別控除の額</th></tr></thead>
      <tbody>
        ${tokuteiRows.map(r=>`<tr><td>${escapeHtml(r.m.name)||'-'}</td><td>${r.age??'-'}</td><td class="mono">¥${fmt(r.agi)}</td><td class="mono">¥${fmt(r.tokutei)}</td></tr>`).join('')||'<tr><td colspan="4">該当なし</td></tr>'}
      </tbody>
      <tfoot><tr><th colspan="3" style="text-align:right">合計</th><th class="mono">¥${fmt(tokuteiTotal)}</th></tr></tfoot>
    </table>
  `;

  // 所得金額調整控除
  const b4 = document.createElement('div');
  b4.className='box';
  b4.innerHTML = `
    <h4>◆ 所得金額調整控除申告書</h4>
    <div class="kv">
      <div>要件</div><div>${chousei.eligible?('該当（'+chousei.reason+'）'):'該当なし'}</div>
      <div>控除額（概算）</div><div class="mono">${chousei.eligible?('¥'+fmt(chousei.amount)):'—'}</div>
      <div class="subtle">※ 実際の計算は勤務先（主たる給与の支払者）が行います（最大15万円）。</div>
    </div>
  `;

  blocks.append(b1,b2,b3,b4);
  sheet.appendChild(blocks);
}

function escapeHtml(s){
  if(!s && s!==0) return '';
  return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
}

// 初期行
addMember('配偶者');
addMember('子');

</script>
</body>
</html>
