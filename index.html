<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>äººçš„æ§é™¤ã‚¢ãƒ—ãƒª r4ï¼ˆåŸºãƒ»é…ãƒ»ç‰¹ãƒ»æ‰€ è»¢è¨˜ã‚·ãƒ¼ãƒˆå¯¾å¿œãƒ»é…å¶è€…æœ‰ç„¡ï¼†ãƒªã‚»ãƒƒãƒˆç‰ˆï¼‰</title>
<style>
  /* â–¼ã“ã“ã‚’â€œã„ã¤ã‚‚ã®ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰â€ã«ç½®ãæ›ãˆå¯ï¼ˆãƒ†ãƒ¼ãƒUIã§ã‚‚å¤‰æ›´å¯èƒ½ï¼‰ */
  :root{
    --ink:#27364B;        /* æ–‡å­—è‰²ï¼ˆæ¿ƒã„è—ï¼‰ */
    --muted:#7A90A6;      /* ã‚µãƒ–æ–‡å­—ï¼ˆç°é’ï¼‰ */
    --bg:#F4F8FB;         /* èƒŒæ™¯ï¼ˆè–„ã„é’ç°ï¼‰ */
    --accent:#1FA0F2;     /* å¼·èª¿è‰²ï¼ˆãƒœã‚¿ãƒ³ç­‰ï¼‰ */
    --border:#E6EDF5;     /* æ ç·šï¼ˆè–„ã„é’ç°ï¼‰ */
  }
  html,body{margin:0;padding:0;color:var(--ink);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;background:#fff}
  header{position:sticky;top:0;background:#fff;z-index:5;border-bottom:1px solid var(--border)}
  header .bar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 14px}
  header h1{font-size:16px;margin:0}
  main{display:grid;grid-template-columns: minmax(480px,560px) 1fr;gap:14px;padding:14px}
  .panel{border:1px solid var(--border);border-radius:12px;background:#fff}
  .panel h2{font-size:15px;margin:0;padding:12px 14px;border-bottom:1px solid var(--border)}
  .panel .content{padding:12px 14px}
  .row{display:grid;grid-template-columns: 1fr 1fr;gap:8px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:12px;color:var(--muted)}
  .field input, .field select{padding:8px;border:1px solid var(--border);border-radius:8px;font-size:14px}
  .muted{color:var(--muted)}
  button{appearance:none;border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
  button.primary{background:var(--accent);color:#fff;border-color:transparent}
  .members{display:flex;flex-direction:column;gap:10px}
  .member{border:1px dashed var(--border);border-radius:10px;padding:10px}
  .member header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .member h3{font-size:14px;margin:0}
  .member .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .hint{font-size:12px;color:var(--muted)}

  /* çµæœ */
  .results{display:grid;grid-template-columns: repeat(2, minmax(280px, 1fr)); gap:12px}
  .card{border:1px solid var(--border);border-radius:12px;padding:12px}
  .card h3{margin:0 0 6px 0;font-size:14px}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border:1px solid var(--border);padding:6px 8px;text-align:left}

  /* è»¢è¨˜ã‚·ãƒ¼ãƒˆï¼ˆA4æ¨ªãƒ»æ§˜å¼æº–æ‹ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ */
  .sheet{--gap:8px;background:#fff;border:2px solid #000;border-radius:0;padding:8px;display:grid;gap:8px}
  .sheet .title{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #000;padding-bottom:6px}
  .sheet h2{font-size:16px;margin:0}
  .sheet .topline{display:grid;grid-template-columns:2fr 2fr 1fr;gap:8px}
  .box{border:1px solid #000;padding:8px}
  .box h4{margin:0 0 6px 0;font-size:13px}
  .kv{display:grid;grid-template-columns: 240px 1fr;gap:6px}
  .kv div{display:flex;gap:6px;align-items:center}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .subtle{color:#444}

  .grid-2{display:grid;grid-template-columns: 1fr 1fr;gap:8px}
  .grid-3{display:grid;grid-template-columns: repeat(3,1fr);gap:8px}

  .badge{font-size:11px;border:1px solid #000;padding:2px 6px;display:inline-block}
  .right{justify-self:end}

  .print-bar{display:flex;gap:8px;align-items:center}
  .theme{display:none;gap:8px;align-items:end}
  .theme input{width:110px}

  .inline-note{font-size:12px;color:var(--muted)}

  footer{border-top:1px solid var(--border);padding:14px;color:var(--muted);font-size:12px;text-align:center}

  @media print{
    @page{size:A4 landscape;margin:10mm}
    header, .no-print{display:none !important}
    main{display:block;padding:0}
    .sheet{border:none}
  }
</style>
</head>
<body>
  <header>
    <div class="bar">
      <h1>äººçš„æ§é™¤ã‚¢ãƒ—ãƒª r4ï¼ˆåŸºãƒ»é…ãƒ»ç‰¹ãƒ»æ‰€ è»¢è¨˜ã‚·ãƒ¼ãƒˆå¯¾å¿œãƒ»é…å¶è€…æœ‰ç„¡ï¼†ãƒªã‚»ãƒƒãƒˆç‰ˆï¼‰</h1>
      <div class="print-bar no-print">
        <button onclick="recalc()">å†è¨ˆç®—</button>
        <button id="resetBtn" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="themeBtn" onclick="toggleTheme()">ğŸ¨ãƒ†ãƒ¼ãƒ</button>
        <button class="primary" onclick="window.print()">A4æ¨ªã§å°åˆ·</button>
      </div>
    </div>
    <div class="no-print" style="padding:0 14px 10px 14px">
      <div class="theme" id="themePanel">
        <div class="field"><label>#INK</label><input id="c_ink" placeholder="#111111"></div>
        <div class="field"><label>#MUTED</label><input id="c_muted" placeholder="#6b7280"></div>
        <div class="field"><label>#BG</label><input id="c_bg" placeholder="#f8fafc"></div>
        <div class="field"><label>#ACCENT</label><input id="c_accent" placeholder="#0ea5e9"></div>
        <div class="field"><label>#BORDER</label><input id="c_border" placeholder="#e5e7eb"></div>
        <button onclick="applyTheme()">é©ç”¨</button>
      </div>
    </div>
  </header>

  <main>
    <!-- å·¦ï¼šå…¥åŠ› -->
    <section class="panel">
      <h2>â‘  ä¸–å¸¯ãƒ»æœ¬äººæƒ…å ±</h2>
      <div class="content">
        <div class="field"><label>çµ¦ä¸ã®æ”¯æ‰•è€…ï¼ˆå‹¤å‹™å…ˆåï¼‰</label><input id="employer" placeholder="â—‹â—‹æ ªå¼ä¼šç¤¾"/></div>
        <div class="field"><label>ã‚ãªãŸã®æ°åï¼ˆæœ¬äººï¼‰</label><input id="youName" placeholder="å±±ç”° å¤ªéƒ"/></div>
        <div class="row">
          <div class="field"><label>ã‚ãªãŸã®ãµã‚ŠãŒãª</label><input id="youKana" placeholder="ãƒ¤ãƒãƒ€ ã‚¿ãƒ­ã‚¦"/></div>
          <div class="field"><label>ã‚ãªãŸã®ä½æ‰€</label><input id="youAddr" placeholder="æ±äº¬éƒ½â—‹â—‹åŒºâ€¦"/></div>
        </div>
        <div class="row">
          <div class="field"><label>ã‚ãªãŸã®ç”Ÿå¹´æœˆæ—¥</label><input id="youDOB" type="date"/></div>
          <div class="field"><label>ã‚ãªãŸã®çµ¦ä¸åå…¥ï¼ˆè¦‹ç©ï¼‰</label><div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <input id="youSalary" class="num" inputmode="numeric" placeholder="ä¾‹ 5,500,000"/>
              <span class="inline-note">çµ¦ä¸æ‰€å¾—é‡‘é¡ï¼š<b id="youSalaryAfter" class="mono">â€”</b></span>
            </div></div>
        </div>
        <div class="row">
          <div class="field"><label>ã‚ãªãŸã®çµ¦ä¸ä»¥å¤–ã®æ‰€å¾—ï¼ˆè¦‹ç©ï¼‰</label><input id="youOther" class="num" inputmode="numeric" value="0"/></div>
          <div class="field"><label>éšœå®³è€…åŒºåˆ†</label>
            <select id="youDis">
              <option value="none">è©²å½“ãªã—</option>
              <option value="disabled">éšœå®³è€…</option>
              <option value="tokubetsu">ç‰¹åˆ¥éšœå®³è€…</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>â‘¡ å®¶æ—æƒ…å ±ï¼ˆé…å¶è€…ãƒ»æ‰¶é¤Šè¦ªæ—ç­‰ï¼‰</h2>
      <div class="content">
        <div class="row" style="margin-bottom:8px">
          <div class="field">
            <label>é…å¶è€…ã®æœ‰ç„¡</label>
            <select id="hasSpouse" onchange="onSpouseToggle(this.value)">
              <option value="no">ãªã—</option>
              <option value="yes">ã‚ã‚Š</option>
            </select>
          </div>
        </div>
        <div class="members" id="members"></div>
        <div class="no-print" style="margin-top:8px;display:flex;gap:8px">
          <!-- é…å¶è€…ã¯1åé™å®šãªã®ã§è¿½åŠ ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤ -->
          <button onclick="addMember('å­')">å­ã‚’è¿½åŠ </button>
          <button onclick="addMember('ãã®ä»–è¦ªæ—')">ãã®ä»–è¦ªæ—ã‚’è¿½åŠ </button>
        </div>
        <p class="hint">â€» çµ¦ä¸åå…¥ã‚’å…¥ã‚Œã‚‹ã¨ã€è‡ªå‹•çš„ã«åˆè¨ˆæ‰€å¾—é‡‘é¡ï¼ˆç°¡æ˜“è¨ˆç®—ï¼‰ã¸å¤‰æ›ã—ã¾ã™ï¼ˆçµ¦ä¸æ‰€å¾—æ§é™¤ã®æœ€ä½ä¿éšœé¡ <b>65ä¸‡å††</b> ã‚’åæ˜ ï¼‰ã€‚</p>
      </div>
    </section>

    <!-- å³ï¼šè¨ˆç®—ã¨è»¢è¨˜ã‚·ãƒ¼ãƒˆ -->
    <section class="panel" style="grid-column: 1 / -1">
      <h2>â‘¢ è¨ˆç®—çµæœ</h2>
      <div class="content">
        <div class="results" id="results"></div>
      </div>
    </section>

    <section class="panel" style="grid-column: 1 / -1">
      <h2>â‘£ è»¢è¨˜ã‚·ãƒ¼ãƒˆï¼ˆä»¤å’Œ7å¹´åˆ†ã€ŒåŸºãƒ»é…ãƒ»ç‰¹ãƒ»æ‰€ã€æ§˜å¼ã«åˆã‚ã›ãŸä¸‹æ›¸ãï¼‰</h2>
      <div class="content">
        <div class="sheet" id="sheet">
          <!-- JSãŒåŸ‹ã‚è¾¼ã¿ -->
        </div>
        <p class="hint">
          ãƒ»ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯ <span class="mono">2025bun_06.pdf</span> ã®ã€Œçµ¦ä¸æ‰€å¾—è€…ã®åŸºç¤æ§é™¤ç”³å‘Šæ›¸ï¼é…å¶è€…æ§é™¤ç­‰ç”³å‘Šæ›¸ï¼ç‰¹å®šè¦ªæ—ç‰¹åˆ¥æ§é™¤ç”³å‘Šæ›¸ï¼æ‰€å¾—é‡‘é¡èª¿æ•´æ§é™¤ç”³å‘Šæ›¸ã€è¦‹æœ¬ã«æ²¿ã£ãŸä¸‹æ›¸ãã§ã™ï¼ˆA4æ¨ªï¼‰ã€‚<br/>
          ãƒ»å®Ÿéš›ã®æ§˜å¼ã«ã¯å€‹äººç•ªå·æ¬„ã‚„æŠ¼å°æ¬„ç­‰ãŒã‚ã‚Šã¾ã™ã€‚æœ¬ã‚·ãƒ¼ãƒˆã¯ä¸‹æ›¸ãè£œåŠ©ã§ã™ã€‚æœ€çµ‚è¨˜å…¥ã¯å›½ç¨åºæ§˜å¼ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
        </p>
      </div>
    </section>
  </main>

  <footer class="no-print">
    Copyright (c) 2025 ç¨ç†å£«æ³•äººæ¾æœ¬ä¼šè¨ˆäº‹å‹™æ‰€ All Rights Reserved. / <b>r6</b>
  </footer>

<script>
// ====== ãƒ†ãƒ¼ãƒï¼ˆé…è‰²ï¼‰ ======
function toggleTheme(){ const p=document.getElementById('themePanel'); p.style.display = (p.style.display==='flex')? 'none' : 'flex'; if(p.style.display==='flex'){ // æ—¢å­˜å€¤ã‚’åæ˜ 
  document.getElementById('c_ink').value = getComputedStyle(document.documentElement).getPropertyValue('--ink').trim();
  document.getElementById('c_muted').value = getComputedStyle(document.documentElement).getPropertyValue('--muted').trim();
  document.getElementById('c_bg').value = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim();
  document.getElementById('c_accent').value = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
  document.getElementById('c_border').value = getComputedStyle(document.documentElement).getPropertyValue('--border').trim();
}}
function applyTheme(){ const r=document.documentElement.style; r.setProperty('--ink', document.getElementById('c_ink').value||'#111111'); r.setProperty('--muted', document.getElementById('c_muted').value||'#6b7280'); r.setProperty('--bg', document.getElementById('c_bg').value||'#f8fafc'); r.setProperty('--accent', document.getElementById('c_accent').value||'#0ea5e9'); r.setProperty('--border', document.getElementById('c_border').value||'#e5e7eb'); }

// ====== ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ« ======
const el = (sel) => document.querySelector(sel);
let members = []; // household except "æœ¬äºº"ï¼ˆæœ¬äººã¯å€‹åˆ¥å…¥åŠ›æ¬„ï¼‰

function addMember(kind){
  if(kind==='é…å¶è€…'){
    const already = members.find(m=>m.kind==='é…å¶è€…');
    if(already) return; // 1åã®ã¿
  }
  const id = crypto.randomUUID();
  const m = { id, kind, name:"", kana:"", dob:"", salary:0, other:0, disabled:"none", cohabit:true };
  members.push(m);
  renderMembers();
  recalc();
}

function removeMember(id){
  members = members.filter(m=>m.id!==id);
  renderMembers();
  recalc();
}

function onSpouseToggle(val){
  if(val==='yes'){
    const sp = members.find(m=>m.kind==='é…å¶è€…');
    if(!sp) addMember('é…å¶è€…');
  }else{
    members = members.filter(m=>m.kind!=='é…å¶è€…');
    renderMembers();
    recalc();
  }
}

function renderMembers(){
  const wrap = el('#members');
  wrap.innerHTML = '';
  members.forEach((m,idx)=>{
    const div = document.createElement('div');
    div.className = 'member';
    div.innerHTML = `
      <header>
        <h3>${idx+1}. ${m.kind}</h3>
        <button class="no-print" onclick="removeMember('${m.id}')">å‰Šé™¤</button>
      </header>
      <div class="grid">
        <div class="field"><label>æ°å</label><input value="${m.name}" oninput="onEdit('${m.id}','name',this.value)"/></div>
        <div class="field"><label>ãµã‚ŠãŒãª</label><input value="${m.kana}" oninput="onEdit('${m.id}','kana',this.value)"/></div>
        <div class="field"><label>ç”Ÿå¹´æœˆæ—¥</label><input type="date" value="${m.dob}" oninput="onEdit('${m.id}','dob',this.value)"/></div>
        <div class="field"><label>çµ¦ä¸åå…¥ï¼ˆè¦‹ç©ï¼‰</label><input type="number" min="0" step="1000" value="${m.salary}" oninput="onEdit('${m.id}','salary',Number(this.value||0))"/></div>
        <div class="field"><label>çµ¦ä¸ä»¥å¤–ã®æ‰€å¾—ï¼ˆè¦‹ç©ï¼‰</label><input type="number" min="0" step="1000" value="${m.other}" oninput="onEdit('${m.id}','other',Number(this.value||0))"/></div>
        <div class="field"><label>éšœå®³è€…åŒºåˆ†</label>
          <select oninput="onEdit('${m.id}','disabled',this.value)">
            <option ${m.disabled==='none'?'selected':''} value="none">è©²å½“ãªã—</option>
            <option ${m.disabled==='disabled'?'selected':''} value="disabled">éšœå®³è€…</option>
            <option ${m.disabled==='tokubetsu'?'selected':''} value="tokubetsu">ç‰¹åˆ¥éšœå®³è€…</option>
          </select>
        </div>
        <div class="field"><label>åŒå±…ï¼ˆä¸–å¸¯å†…ï¼‰</label>
          <select oninput="onEdit('${m.id}','cohabit',this.value==='true')">
            <option value="true" ${m.cohabit? 'selected':''}>ã¯ã„</option>
            <option value="false" ${!m.cohabit? 'selected':''}>ã„ã„ãˆ</option>
          </select>
        </div>
      </div>
    `;
    wrap.appendChild(div);
  })
}

function onEdit(id, key, val){
  const m = members.find(x=>x.id===id);
  if(!m) return;
  m[key] = val;
  recalc();
}

// ====== è¨ˆç®—ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
function kyuyoShotokuKojo(s){
  s = Number(s||0);
  if(s<=0) return 0;
  if(s<=1625000) return 650000;
  if(s<=1800000) return Math.floor(s*0.4 - 100000);
  if(s<=3600000) return Math.floor(s*0.3 + 80000);
  if(s<=6600000) return Math.floor(s*0.2 + 440000);
  if(s<=8500000) return Math.floor(s*0.1 + 1100000);
  return 1950000;
}
function salaryToIncome(s){
  s = Number(s||0);
  const income = Math.max(0, s - kyuyoShotokuKojo(s));
  return Math.round(income);
}

function ageAt(dob){ if(!dob) return null; const dt=new Date(dob); if(isNaN(dt)) return null; const today=new Date(); let age=today.getFullYear()-dt.getFullYear(); const m=today.getMonth()-dt.getMonth(); if(m<0 || (m===0 && today.getDate()<dt.getDate())) age--; return age; }

function agiOf(person){ // åˆè¨ˆæ‰€å¾—é‡‘é¡ï¼ˆç°¡æ˜“ï¼‰
  return salaryToIncome(person.salary) + Number(person.other||0);
}

// åŸºç¤æ§é™¤ï¼ˆR7æ”¹æ­£å¾Œã®åŠ ç®—å¾Œé¡ï¼‰
function basicDeductionR7(agi){
  if(agi<=1320000) return 950000; // 95ä¸‡
  if(agi<=3360000) return 880000; // 88ä¸‡
  if(agi<=4890000) return 680000; // 68ä¸‡
  if(agi<=6550000) return 630000; // 63ä¸‡
  if(agi<=23500000) return 580000; // 58ä¸‡
  // ä»¥é™ã¯å±…ä½è€…åŠ ç®—ãªã—ã®æ—§æ®µéšï¼ˆPDFã«è¡¨ç¤ºã‚ã‚Šï¼‰ã€‚å®‰å…¨å´ã§48/32/16ã‚’æ¡ç”¨ã€‚
  if(agi<=24000000) return 480000;
  if(agi<=24500000) return 320000;
  return 160000;
}

// åŒºåˆ†â… ï¼ˆæœ¬äººï¼‰â€¦å¾“æ¥ã©ãŠã‚Š A:900ä¸‡ä»¥ä¸‹ / B:900è¶…ã€œ950ä»¥ä¸‹ / C:950è¶…ã€œ1000ä»¥ä¸‹
function kubunI(agi){
  if(agi<=9000000) return 'A';
  if(agi<=9500000) return 'B';
  if(agi<=10000000) return 'C';
  return '-';
}

// é…å¶è€…æ§é™¤ or é…å¶è€…ç‰¹åˆ¥æ§é™¤ï¼ˆR7ã®é–¾å€¤åæ˜ ï¼‰
function spouseDeductionR7(taxpayerAgi, spouseAgi, spouseAge){
  if(spouseAgi>1330000 || taxpayerAgi>10000000) return {type:'å¯¾è±¡å¤–', amount:0, kubunII:'-'};
  // åŒºåˆ†â…¡ï¼ˆå‚è€ƒï¼šzeimo ç­‰ã®è§£èª¬ã«åŸºã¥ãï¼‰
  let kubunII;
  if(spouseAgi<=580000){ kubunII = (spouseAge>=70)? 'â‘ ' : 'â‘¡'; }
  else if(spouseAgi<=950000){ kubunII = 'â‘¢'; }
  else { kubunII = 'â‘£'; }

  // æ§é™¤é¡è¡¨ï¼ˆæœ¬äººåŒºåˆ†Ã—é…å¶è€…åŒºåˆ†ï¼‰ã‚’æ•°å€¤åŒ–ï¼ˆR7ãƒ»ä¸€èˆ¬é…å¶è€…ï¼‰
  // ä¾¿å®œä¸Šã€ç¨é¡è¡¨ã®ä»£è¡¨å€¤ã‚’ä½¿ç”¨ï¼ˆå®Ÿå‹™ã¯æ§˜å¼è¡¨ã«å¾“ã£ã¦ãã ã•ã„ï¼‰ã€‚
  const A = { 'â‘ ':380000, 'â‘¡':380000, 'â‘¢':380000, 'â‘£':260000 };
  const B = { 'â‘ ':260000, 'â‘¡':260000, 'â‘¢':260000, 'â‘£':130000 };
  const C = { 'â‘ ':130000, 'â‘¡':130000, 'â‘¢':130000, 'â‘£':  0   };
  const row = (taxpayerAgi<=9000000)?A : (taxpayerAgi<=9500000?B:C);

  // åŒºåˆ†â…¡â‘¢ãƒ»â‘£ ã®ã†ã¡é…å¶è€…ç‰¹åˆ¥æ§é™¤ã¯æ‰€å¾—éšå±¤ã«ã‚ˆã‚Šé€“æ¸›ï¼ˆä¸‹è¡¨ã‚’è¿‘ä¼¼ï¼‰
  let base = row[kubunII]||0;
  if(kubunII==='â‘¢'){
    // 58è¶…95ä»¥ä¸‹ï¼šæœ€å¤§ 38/26/13 ã‚’ç¶­æŒ
    base = row['â‘¢'];
  }else if(kubunII==='â‘£'){
    // 95è¶…133ä»¥ä¸‹ï¼šé€“æ¸›ã€‚ãŠãŠã‚€ã­ 26â†’0ï¼ˆAå¸¯ï¼‰/13â†’0ï¼ˆBå¸¯ï¼‰/0ï¼ˆCå¸¯ï¼‰
    // ã“ã“ã§ã¯ç·šå½¢è¿‘ä¼¼ï¼ˆ95ã€œ133ã§0ã¸ï¼‰ã€‚
    const span = 1330000 - 950000;
    const t = Math.max(0, Math.min(1, (spouseAgi-950000)/span));
    base = Math.round(row['â‘£'] * (1 - t));
  }
  const type = (kubunII==='â‘ ' || kubunII==='â‘¡')? 'é…å¶è€…æ§é™¤' : 'é…å¶è€…ç‰¹åˆ¥æ§é™¤';
  return {type, amount: base, kubunII};
}

// æ‰¶é¤Šæ§é™¤ï¼ˆ16æ­³ä»¥ä¸Šã®æ‰¶é¤Šè¦ªæ—ã€è€äºº/åŒå±…è€è¦ªç­‰/ç‰¹å®šæ‰¶é¤Šï¼‰â€»ã–ã£ãã‚Š
function fuyouDeduction(member){
  const age = ageAt(member.dob);
  const agi = agiOf(member);
  if(agi>580000) return 0; // R7æ”¹æ­£
  if(age===null) return 0;
  if(age>=70){ return member.cohabit? 580000 : 480000; }
  if(age>=19 && age<23){ return 630000; } // ç‰¹å®šæ‰¶é¤Šè¦ªæ—ï¼ˆR7ã§ã‚‚æ®ç½®ï¼‰
  if(age>=16){ return 380000; }
  return 0;
}

// ç‰¹å®šè¦ªæ—ç‰¹åˆ¥æ§é™¤ï¼ˆR7æ–°è¨­ï¼‰â€¦è²¡å‹™çœå¤§ç¶±ã®è¡¨ã«åŸºã¥ã
function tokuteiShinzokuTokubetsu(member){
  const age = ageAt(member.dob);
  const agi = agiOf(member);
  if(!(age>=19 && age<23)) return 0;
  if(agi<=580000) return 0; // 58ä¸‡å††ä»¥ä¸‹ã¯å¾“æ¥ã®ç‰¹å®šæ‰¶é¤Šã¸ï¼ˆæ§é™¤ã¯æ‰¶é¤Šæ§é™¤ã§å¯¾å¿œï¼‰
  if(agi<=850000) return 630000;
  if(agi<=900000) return 610000;
  if(agi<=950000) return 510000;
  if(agi<=1000000) return 410000;
  if(agi<=1050000) return 310000;
  if(agi<=1100000) return 210000;
  if(agi<=1150000) return 110000;
  if(agi<=1200000) return  60000;
  if(agi<=1230000) return  30000;
  return 0;
}

// æ‰€å¾—é‡‘é¡èª¿æ•´æ§é™¤ï¼ˆå¹´å > 850ä¸‡ã§è¦ä»¶ãŒã‚ã‚Œã°ï¼‰â€¦ç°¡æ˜“
function shotokuChousei(taxpayer, family){
  const salary = Number(taxpayer.salary||0);
  if(salary<=8500000) return {eligible:false, reason:"è¦ä»¶å¤–", amount:0};
  const hasUnder23 = family.some(m=>{const a=ageAt(m.dob); return a!==null && a<23;});
  const hasTokubetsuDisabled = (taxpayer.disabled==='tokubetsu') || family.some(m=>m.disabled==='tokubetsu');
  if(!(hasUnder23 || hasTokubetsuDisabled)) return {eligible:false, reason:"è©²å½“è€…ãªã—", amount:0};
  // æ¦‚ç®—ï¼šæœ€å¤§15ä¸‡å††ã®ç¯„å›²ã€‚ã“ã“ã§ã¯ 10ä¸‡å††ã¨ã™ã‚‹ï¼ˆå®Ÿå‹™ã¯åˆ¥è¨ˆç®—ï¼‰ã€‚
  return {eligible:true, reason: hasUnder23?"23æ­³æœªæº€ã®æ‰¶é¤Šè¦ªæ—ã‚ã‚Š":"ç‰¹åˆ¥éšœå®³è€…ã‚ã‚Š", amount:100000};
}

function fmt(n){ return (n===null||n===undefined||isNaN(n)? 0 : Number(n)).toLocaleString('ja-JP'); }
function yen(n){ return 'Â¥'+fmt(n); }
function parseNum(v){ if(v===undefined||v===null) return 0; return Number(String(v).replace(/[^0-9.-]/g,'')||0); }
function attachComma(){
  Array.from(document.querySelectorAll('input.num')).forEach(el=>{
    el.addEventListener('input', ()=>{
      const raw = parseNum(el.value);
      el.value = raw.toLocaleString('ja-JP');
      recalc();
    });
  });
}

// ====== ãƒªã‚»ãƒƒãƒˆ ======
function resetAll(){
  if(!confirm('å…¥åŠ›å†…å®¹ã‚’ã™ã¹ã¦åˆæœŸåŒ–ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  // æœ¬äºº
  el('#employer').value=''; el('#youName').value=''; el('#youKana').value=''; el('#youAddr').value=''; el('#youDOB').value='';
  el('#youSalary').value=''; el('#youOther').value='0'; el('#youDis').value='none';
  // é…å¶è€…æœ‰ç„¡
  const spSel = el('#hasSpouse'); spSel.value='no';
  // å®¶æ—ãƒ‡ãƒ¼ã‚¿
  members = [];
  renderMembers();
  recalc();
}

// ====== é›†è¨ˆ ======
function recalc(){
  // å…¥åŠ›
  const you = {
    name: el('#youName').value.trim(), kana: el('#youKana').value.trim(), addr: el('#youAddr').value.trim(), dob: el('#youDOB').value,
    salary: parseNum(el('#youSalary').value), other: parseNum(el('#youOther').value), disabled: el('#youDis').value
  };
  const employer = el('#employer').value.trim();

  const youAGI = agiOf(you);
  // æœ¬äºº çµ¦ä¸æ‰€å¾—é‡‘é¡ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³è¡¨ç¤º
  const soEl = document.getElementById('youSalaryAfter'); if(soEl){ soEl.textContent = yen(salaryToIncome(you.salary)); }
  const youBasic = basicDeductionR7(youAGI);
  const kubun1 = kubunI(youAGI);

  // é…å¶è€…ï¼ˆ1äººå›ºå®šãƒ»æœ‰ç„¡åˆ¤å®šï¼‰
  const spouse = members.find(m=>m.kind==='é…å¶è€…');
  let spouseInfo = {type:'å¯¾è±¡å¤–', amount:0, kubunII:'-', agi:0, age:null, name:'', kana:''};
  if(spouse){
    spouseInfo = spouseDeductionR7(youAGI, agiOf(spouse), ageAt(spouse.dob));
    spouseInfo.agi = agiOf(spouse);
    spouseInfo.age = ageAt(spouse.dob);
    spouseInfo.name = spouse.name; spouseInfo.kana = spouse.kana;
  }

  // æ‰¶é¤Šæ§é™¤åˆè¨ˆ
  const dependents = members.filter(m=>m.kind!=='é…å¶è€…');
  const fuyouRows = dependents.map(m=>({m, age:ageAt(m.dob), agi:agiOf(m), fuyou:fuyouDeduction(m), tokutei:tokuteiShinzokuTokubetsu(m)}));
  const fuyouTotal = fuyouRows.reduce((a,r)=>a+r.fuyou,0);
  const tokuteiRows = fuyouRows.filter(r=>r.tokutei>0);
  const tokuteiTotal = tokuteiRows.reduce((a,r)=>a+r.tokutei,0);

  const chousei = shotokuChousei(you, members);

  // å³ä¸Šã‚«ãƒ¼ãƒ‰
  const results = el('#results');
  results.innerHTML = '';
  const card1 = document.createElement('div');
  card1.className = 'card';
  card1.innerHTML = `<h3>æœ¬äººã®åˆè¨ˆæ‰€å¾—è¦‹ç©ï¼š<b class="mono">Â¥${fmt(youAGI)}</b></h3>
    <div class="muted">åŸºç¤æ§é™¤ï¼š<b>Â¥${fmt(youBasic)}</b>ï¼ˆåŒºåˆ†â… ï¼š${kubun1}ï¼‰</div>`;
  const card2 = document.createElement('div');
  card2.className='card';
  card2.innerHTML = `<h3>é…å¶è€…æ§é™¤ç­‰ï¼š</h3>
    <div>åŒºåˆ†â…¡ï¼š${spouseInfo.kubunII}ï¼ç¨®é¡ï¼š${spouseInfo.type}ï¼æ§é™¤é¡ï¼š<b>Â¥${fmt(spouseInfo.amount)}</b></div>`;
  const card3 = document.createElement('div'); card3.className='card';
  card3.innerHTML = `<h3>æ‰¶é¤Šæ§é™¤åˆè¨ˆï¼š<b>Â¥${fmt(fuyouTotal)}</b></h3>
    <table class="table"><thead><tr><th>æ°å</th><th>å¹´é½¢</th><th>åˆè¨ˆæ‰€å¾—</th><th>åŒºåˆ†</th><th>æ§é™¤é¡</th></tr></thead><tbody>
      ${fuyouRows.filter(r=>r.fuyou>0).map(r=>`<tr><td>${r.m.name||'-'}</td><td>${r.age??'-'}</td><td class="mono">Â¥${fmt(r.agi)}</td><td>${(r.age>=70?(r.m.cohabit?'åŒå±…è€è¦ªç­‰':'è€äºº'): (r.age>=19&&r.age<23?'ç‰¹å®šæ‰¶é¤Š':'ä¸€èˆ¬'))||'-'}</td><td class="mono">Â¥${fmt(r.fuyou)}</td></tr>`).join('')||'<tr><td colspan="5">â€”</td></tr>'}
    </tbody></table>`;
  const card4 = document.createElement('div'); card4.className='card';
  card4.innerHTML = `<h3>ç‰¹å®šè¦ªæ—ç‰¹åˆ¥æ§é™¤ï¼š<b>Â¥${fmt(tokuteiTotal)}</b></h3>
  <table class="table"><thead><tr><th>æ°å</th><th>å¹´é½¢</th><th>åˆè¨ˆæ‰€å¾—</th><th>æ§é™¤é¡</th></tr></thead><tbody>
    ${tokuteiRows.map(r=>`<tr><td>${r.m.name||'-'}</td><td>${r.age??'-'}</td><td class="mono">Â¥${fmt(r.agi)}</td><td class="mono">Â¥${fmt(r.tokutei)}</td></tr>`).join('')||'<tr><td colspan="4">â€”</td></tr>'}
  </tbody></table>`;
  results.append(card1, card2, card3, card4);

  // ===== è»¢è¨˜ã‚·ãƒ¼ãƒˆæç”» =====
  const sheet = el('#sheet');
  sheet.innerHTML = '';

  // ã‚¿ã‚¤ãƒˆãƒ«ï¼ä¸Šæ®µ
  const title = document.createElement('div');
  title.className = 'title';
  title.innerHTML = `<h2>ä»¤å’Œ7å¹´åˆ†  åŸºç¤æ§é™¤ãƒ»é…å¶è€…æ§é™¤ç­‰ãƒ»ç‰¹å®šè¦ªæ—ç‰¹åˆ¥æ§é™¤ãƒ»æ‰€å¾—é‡‘é¡èª¿æ•´æ§é™¤ï¼ˆä¸‹æ›¸ãï¼‰</h2>
  <div class="subtle">å‹¤å‹™å…ˆï¼š${escapeHtml(employer)||'ï¼ˆæœªå…¥åŠ›ï¼‰'}</div>`;
  sheet.appendChild(title);

  const top = document.createElement('div');
  top.className='topline';
  top.innerHTML = `
    <div class="box">
      <h4>ã‚ãªãŸã®æƒ…å ±ï¼ˆæ°åãƒ»ä½æ‰€ç­‰ï¼‰</h4>
      <div class="kv">
        <div>æ°åï¼ˆãƒ•ãƒªã‚¬ãƒŠï¼‰</div><div><b>${escapeHtml(you.name)||'â€”'}</b>ï¼ˆ${escapeHtml(you.kana)||'â€”'}ï¼‰</div>
        <div>ä½æ‰€</div><div>${escapeHtml(you.addr)||'â€”'}</div>
        <div>ç”Ÿå¹´æœˆæ—¥</div><div>${you.dob||'â€”'}</div>
        <div>æœ¬äººã®åˆè¨ˆæ‰€å¾—è¦‹ç©é¡</div><div class="mono">Â¥${fmt(youAGI)}</div>
      </div>
    </div>
    <div class="box">
      <h4>é…å¶è€…ã®æƒ…å ±ï¼ˆé…å¶è€…æ§é™¤ç­‰ç”³å‘Šæ›¸ï¼‰</h4>
      <div class="kv">
        <div>é…å¶è€…æ°åï¼ˆãƒ•ãƒªã‚¬ãƒŠï¼‰</div><div><b>${escapeHtml(spouse?.name)||'â€”'}</b>ï¼ˆ${escapeHtml(spouse?.kana)||'â€”'}ï¼‰</div>
        <div>é…å¶è€…ç”Ÿå¹´æœˆæ—¥</div><div>${spouse?.dob||'â€”'}ï¼ˆå¹´é½¢ï¼š${spouseInfo.age??'â€”'}ï¼‰</div>
        <div>é…å¶è€…ã®åˆè¨ˆæ‰€å¾—è¦‹ç©é¡</div><div class="mono">Â¥${fmt(spouseInfo.agi)||'0'}</div>
      </div>
    </div>
    <div class="box">
      <h4>ãƒã‚§ãƒƒã‚¯</h4>
      <div class="kv">
        <div>æœ¬äºº åŒºåˆ†â… </div><div class="mono">${kubun1}</div>
        <div>é…å¶è€… åŒºåˆ†â…¡</div><div class="mono">${spouseInfo.kubunII}</div>
        <div>æ‰€å¾—é‡‘é¡èª¿æ•´æ§é™¤</div><div>${chousei.eligible?('é©ç”¨ï¼ˆç†ç”±ï¼š'+chousei.reason+'ï¼‰'):'â€”'}</div>
      </div>
    </div>
  `;
  sheet.appendChild(top);

  // 4ã¤ã®ç”³å‘Šæ›¸ãƒœãƒƒã‚¯ã‚¹
  const blocks = document.createElement('div');
  blocks.className='grid-2';

  // åŸºç¤æ§é™¤
  const b1 = document.createElement('div');
  b1.className='box';
  b1.innerHTML = `
    <h4>â—† çµ¦ä¸æ‰€å¾—è€…ã®åŸºç¤æ§é™¤ç”³å‘Šæ›¸</h4>
    <div class="kv">
      <div>æœ¬å¹´ä¸­ã®åˆè¨ˆæ‰€å¾—é‡‘é¡ã®è¦‹ç©é¡ï¼ˆâ‘ +â‘¡ï¼‰</div><div class="mono">Â¥${fmt(youAGI)}</div>
      <div>åˆ¤å®š â†’ åŒºåˆ†â… </div><div class="mono">${kubun1}</div>
      <div>åŸºç¤æ§é™¤ã®é¡</div><div class="mono"><b>Â¥${fmt(youBasic)}</b></div>
    </div>
  `;

  // é…å¶è€…æ§é™¤ç­‰
  const b2 = document.createElement('div');
  b2.className='box';
  b2.innerHTML = `
    <h4>â—† çµ¦ä¸æ‰€å¾—è€…ã®é…å¶è€…æ§é™¤ç­‰ç”³å‘Šæ›¸</h4>
    <div class="kv">
      <div>é…å¶è€…ã®åˆè¨ˆæ‰€å¾—é‡‘é¡ã®è¦‹ç©é¡ï¼ˆâ‘ +â‘¡ï¼‰</div><div class="mono">Â¥${fmt(spouseInfo.agi)}</div>
      <div>åŒºåˆ†â…¡ï¼ˆâ‘ ã€œâ‘£ï¼‰</div><div class="mono">${spouseInfo.kubunII}</div>
      <div>æ§é™¤é¡ã®è¨ˆç®— â†’ ç¨®é¡</div><div>${spouseInfo.type}</div>
      <div>é…å¶è€…æ§é™¤ï¼é…å¶è€…ç‰¹åˆ¥æ§é™¤ã®é¡</div><div class="mono"><b>Â¥${fmt(spouseInfo.amount)}</b></div>
    </div>
  `;

  // ç‰¹å®šè¦ªæ—ç‰¹åˆ¥æ§é™¤
  const b3 = document.createElement('div');
  b3.className='box';
  b3.innerHTML = `
    <h4>â—† çµ¦ä¸æ‰€å¾—è€…ã®ç‰¹å®šè¦ªæ—ç‰¹åˆ¥æ§é™¤ç”³å‘Šæ›¸</h4>
    <table class="table">
      <thead><tr><th>ç‰¹å®šè¦ªæ—ã®æ°å</th><th>å¹´é½¢</th><th>åˆè¨ˆæ‰€å¾—è¦‹ç©é¡</th><th>ç‰¹å®šè¦ªæ—ç‰¹åˆ¥æ§é™¤ã®é¡</th></tr></thead>
      <tbody>
        ${tokuteiRows.map(r=>`<tr><td>${escapeHtml(r.m.name)||'-'}</td><td>${r.age??'-'}</td><td class="mono">Â¥${fmt(r.agi)}</td><td class="mono">Â¥${fmt(r.tokutei)}</td></tr>`).join('')||'<tr><td colspan="4">è©²å½“ãªã—</td></tr>'}
      </tbody>
      <tfoot><tr><th colspan="3" style="text-align:right">åˆè¨ˆ</th><th class="mono">Â¥${fmt(tokuteiTotal)}</th></tr></tfoot>
    </table>
  `;

  // æ‰€å¾—é‡‘é¡èª¿æ•´æ§é™¤
  const b4 = document.createElement('div');
  b4.className='box';
  b4.innerHTML = `
    <h4>â—† æ‰€å¾—é‡‘é¡èª¿æ•´æ§é™¤ç”³å‘Šæ›¸</h4>
    <div class="kv">
      <div>è¦ä»¶</div><div>${chousei.eligible?('è©²å½“ï¼ˆ'+chousei.reason+'ï¼‰'):'è©²å½“ãªã—'}</div>
      <div>æ§é™¤é¡ï¼ˆæ¦‚ç®—ï¼‰</div><div class="mono">${chousei.eligible?('Â¥'+fmt(chousei.amount)):'â€”'}</div>
      <div class="subtle">â€» å®Ÿéš›ã®è¨ˆç®—ã¯å‹¤å‹™å…ˆï¼ˆä¸»ãŸã‚‹çµ¦ä¸ã®æ”¯æ‰•è€…ï¼‰ãŒè¡Œã„ã¾ã™ï¼ˆæœ€å¤§15ä¸‡å††ï¼‰ã€‚</div>
    </div>
  `;

  blocks.append(b1,b2,b3,b4);
  sheet.appendChild(blocks);
}

function escapeHtml(s){
  if(!s && s!==0) return '';
  return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
}

// åˆæœŸè¡Œï¼šé…å¶è€…ã¯æœ‰ç„¡ã§åˆ¶å¾¡ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€Œãªã—ã€ï¼‰ã€‚å­ãƒ»è¦ªæ—ã¯0ä»¶ã‹ã‚‰é–‹å§‹ã€‚
// addMember('å­'); // å¿…è¦ãªã‚‰ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤

// åˆæœŸè¨ˆç®—
attachComma();
recalc();
</script>
</body>
</html>
