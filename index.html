<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>äººçš„æ§é™¤ã‚¢ãƒ—ãƒª r6</title>
<style>
  :root{
    --ink:#27364B;        /* æ–‡å­—è‰²ï¼ˆæ¿ƒã„è—ï¼‰ */
    --muted:#7A90A6;      /* ã‚µãƒ–æ–‡å­—ï¼ˆç°é’ï¼‰ */
    --bg:#F4F8FB;         /* èƒŒæ™¯ï¼ˆè–„ã„é’ç°ï¼‰ */
    --accent:#1FA0F2;     /* å¼·èª¿è‰²ï¼ˆãƒœã‚¿ãƒ³ç­‰ï¼‰ */
    --border:#E6EDF5;     /* æ ç·šï¼ˆè–„ã„é’ç°ï¼‰ */
  }
  html,body{margin:0;padding:0;color:var(--ink);font:14px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:#fff}
  header{position:sticky;top:0;background:#fff;z-index:5;border-bottom:1px solid var(--border)}
  header .bar{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 14px}
  header h1{font-size:16px;margin:0}
  main{display:grid;grid-template-columns:minmax(520px,640px) 1fr;gap:14px;padding:14px}
  .panel{border:1px solid var(--border);border-radius:12px;background:#fff}
  .panel h2{font-size:15px;margin:0;padding:12px 14px;border-bottom:1px solid var(--border)}
  .panel .content{padding:12px 14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:12px;color:var(--muted)}
  .field input,.field select{padding:8px;border:1px solid var(--border);border-radius:8px;font-size:14px}
  button{appearance:none;border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
  .members{display:flex;flex-direction:column;gap:10px}
  .member{border:1px dashed var(--border);border-radius:10px;padding:10px}
  .member header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .member h3{font-size:14px;margin:0}
  .member .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .hint{font-size:12px;color:var(--muted)}
  .inline-note{font-size:12px;color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .right{text-align:right}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--border);padding:6px 8px;text-align:left}
  tfoot td{font-weight:700}
  .sheetWrap{display:none;margin-top:12px}
  .sheet{--gap:8px;background:#fff;border:2px solid #000;border-radius:0;padding:8px;display:grid;gap:8px}
  .sheet .title{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #000;padding-bottom:6px}
  .sheet h2{font-size:16px;margin:0}
  .sheet .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .box{border:1px solid #000;padding:8px}
  .box h4{margin:0 0 6px 0;font-size:13px}
  .kv{display:grid;grid-template-columns:240px 1fr;gap:6px}
  .subtle{color:#444}
  .print-bar{display:flex;gap:8px;align-items:center}
  footer{margin:14px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between}
  @media print{@page{size:A4 landscape;margin:10mm} header,.no-print{display:none!important} main{display:block;padding:0} .sheet{border:none}}
</style>
</head>
<body>
<header>
  <div class="bar">
    <h1>äººçš„æ§é™¤ã‚¢ãƒ—ãƒª r6</h1>
    <div class="print-bar no-print">
      <button onclick="calcAll()">å†è¨ˆç®—</button>
      <button id="toggleSheetBtn" onclick="toggleSheet()">è»¢è¨˜ã‚·ãƒ¼ãƒˆã‚’è¡¨ç¤º</button>
      <button onclick="window.print()">å°åˆ·</button>
      <button onclick="exportPDF()">PDFä½œæˆï¼ˆè»¢è¨˜ã‚·ãƒ¼ãƒˆï¼‰</button>
      <button onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
      <button onclick="toggleTheme()">ğŸ¨ãƒ†ãƒ¼ãƒ</button>
    </div>
  </div>
</header>

<main>
  <!-- â‘  æœ¬äºº -->
  <section class="panel">
    <h2>â‘  ä¸–å¸¯ãƒ»æœ¬äººæƒ…å ±</h2>
    <div class="content">
      <div class="field"><label>çµ¦ä¸ã®æ”¯æ‰•è€…ï¼ˆå‹¤å‹™å…ˆåï¼‰</label><input id="employer" placeholder="â—‹â—‹æ ªå¼ä¼šç¤¾"></div>
      <div class="field"><label>ã‚ãªãŸã®æ°åï¼ˆæœ¬äººï¼‰</label><input id="youName" placeholder="å±±ç”° å¤ªéƒ"></div>
      <div class="row">
        <div class="field"><label>ã‚ãªãŸã®ãµã‚ŠãŒãª</label><input id="youKana" placeholder="ãƒ¤ãƒãƒ€ ã‚¿ãƒ­ã‚¦"></div>
        <div class="field"><label>ã‚ãªãŸã®ä½æ‰€</label><input id="youAddr" placeholder="æ±äº¬éƒ½â—‹â—‹åŒºâ€¦"></div>
      </div>
      <div class="row">
        <div class="field"><label>ã‚ãªãŸã®ç”Ÿå¹´æœˆæ—¥</label><input id="youDOB" type="date"></div>
        <div class="field"><label>ã‚ãªãŸã®çµ¦ä¸åå…¥ï¼ˆè¦‹ç©ï¼‰</label>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="youSalary" class="num" inputmode="numeric" placeholder="ä¾‹ 5,500,000">
            <span class="inline-note">çµ¦ä¸æ‰€å¾—é‡‘é¡ï¼š<b id="youSalaryAfter" class="mono">â€”</b></span>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="field"><label>ã‚ãªãŸã®çµ¦ä¸ä»¥å¤–ã®æ‰€å¾—ï¼ˆè¦‹ç©ï¼‰</label><input id="youOther" class="num" inputmode="numeric" value="0"></div>
        <div class="field"><label>éšœå®³è€…åŒºåˆ†</label>
          <select id="youDis">
            <option value="none">è©²å½“ãªã—</option>
            <option value="disabled">éšœå®³è€…</option>
            <option value="tokubetsu">ç‰¹åˆ¥éšœå®³è€…</option>
          </select>
        </div>
      </div>
      <div class="box" style="border:1px solid var(--border);border-radius:10px;padding:8px;margin-top:8px">
        <div class="row">
          <div>çµ¦ä¸æ‰€å¾—æ§é™¤ï¼š<b class="mono" id="youKoujo">â€”</b></div>
          <div>çµ¦ä¸æ‰€å¾—é‡‘é¡ï¼š<b class="mono" id="youShotoku">â€”</b></div>
        </div>
        <div>åˆè¨ˆæ‰€å¾—é‡‘é¡ï¼ˆè¦‹ç©ï¼‰ï¼š<b class="mono" id="youAGI">â€”</b></div>
        <div>åŸºç¤æ§é™¤ï¼ˆå‚ç…§ï¼‰ï¼š<b class="mono" id="youBasicIT">â€”</b>ï¼ˆæ‰€å¾—ç¨ï¼‰ï¼<b class="mono" id="youBasicRT">â€”</b>ï¼ˆä½æ°‘ç¨ï¼‰</div>
      </div>
    </div>
  </section>

  <!-- â‘¡ å®¶æ— -->
  <section class="panel">
    <h2>â‘¡ å®¶æ—æƒ…å ±ï¼ˆé…å¶è€…ãƒ»æ‰¶é¤Šè¦ªæ—ç­‰ï¼‰</h2>
    <div class="content">
      <div class="row" style="margin-bottom:8px">
        <div class="field">
          <label>é…å¶è€…ã®æœ‰ç„¡</label>
          <select id="hasSpouse" onchange="onSpouseToggle(this.value)">
            <option value="no">ãªã—</option>
            <option value="yes">ã‚ã‚Š</option>
          </select>
        </div>
      </div>
      <div class="members" id="members"></div>
      <div class="no-print" style="margin-top:8px;display:flex;gap:8px">
        <button onclick="addMember('å­')">å­ã‚’è¿½åŠ </button>
        <button onclick="addMember('ãã®ä»–è¦ªæ—')">ãã®ä»–è¦ªæ—ã‚’è¿½åŠ </button>
      </div>
      <p class="hint">çµ¦ä¸åå…¥ã®å³ã«<b>çµ¦ä¸æ‰€å¾—é‡‘é¡</b>ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã€‚é‡‘é¡å…¥åŠ›ã¯<b>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã‚«ãƒ³ãƒè¡¨ç¤º</b>ã—ã¾ã™ã€‚</p>
    </div>
  </section>

  <!-- â‘¢ ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <section class="panel" style="grid-column:1 / -1">
    <h2>â‘¢ æ§é™¤é¡ãƒ†ãƒ¼ãƒ–ãƒ«</h2>
    <div class="content">
      <table id="resultTbl">
        <thead><tr><th>åŒºåˆ†</th><th class="right">æ‰€å¾—ç¨</th><th class="right">ä½æ°‘ç¨</th><th>ãƒ¡ãƒ¢</th></tr></thead>
        <tbody id="tbody"></tbody>
        <tfoot><tr><td>åˆè¨ˆ</td><td id="sum_itax" class="right">â€”</td><td id="sum_rtax" class="right">â€”</td><td></td></tr></tfoot>
      </table>
    </div>
  </section>

  <!-- â‘£ è»¢è¨˜ã‚·ãƒ¼ãƒˆï¼ˆãƒœã‚¿ãƒ³ã§é–‹é–‰ï¼‰ -->
  <section class="panel sheetWrap" id="sheetPanel" style="grid-column:1 / -1; display:none">
    <h2>â‘£ è»¢è¨˜ã‚·ãƒ¼ãƒˆï¼ˆA4æ¨ªï¼‰</h2>
    <div class="content">
      <div class="sheet" id="sheet"></div>
      <p class="hint">æ§˜å¼ï¼š<b>åŸºç¤æ§é™¤ç”³å‘Šæ›¸ï¼é…å¶è€…æ§é™¤ç­‰ç”³å‘Šæ›¸ï¼ç‰¹å®šè¦ªæ—ç‰¹åˆ¥æ§é™¤ç”³å‘Šæ›¸ï¼æ‰€å¾—é‡‘é¡èª¿æ•´æ§é™¤ç”³å‘Šæ›¸</b>ï¼‹<b>æ‰¶é¤Šæ§é™¤ç­‰ï¼ˆç•°å‹•ï¼‰ç”³å‘Šæ›¸</b>è»¢è¨˜æ¬„ã€‚</p>
    </div>
  </section>
</main>

<footer class="no-print">
  Copyright (c) 2025 ç¨ç†å£«æ³•äººæ¾æœ¬ä¼šè¨ˆäº‹å‹™æ‰€ All Rights Reserved. / <b>r6</b>
</footer>

<script>
const $ = (s)=>document.querySelector(s);
const fmt = (n)=> (n===null||n===undefined||isNaN(n)? 'â€”' : Number(n).toLocaleString('ja-JP'));
const yen = (n)=> 'Â¥'+fmt(n);
const parseNum = (v)=>{ if(v===undefined||v===null) return 0; return Number(String(v).replace(/[^0-9.-]/g,'')||0); };
function attachComma(){
  Array.from(document.querySelectorAll('input.num')).forEach(el=>{
    el.addEventListener('input', ()=>{
      const raw = parseNum(el.value);
      el.value = raw.toLocaleString('ja-JP');
      calcAll(false);
    });
  });
}
function toggleTheme(){
  const hex = prompt('ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ï¼ˆ#ã‹ã‚‰ã®HEXï¼‰', getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#1FA0F2');
  if(!hex) return;
  document.documentElement.style.setProperty('--accent', hex);
}

/* ãƒ¢ãƒ‡ãƒ« */
let members = [];
function addMember(kind){
  if(kind==='é…å¶è€…' && members.some(x=>x.kind==='é…å¶è€…')) return;
  const id = (crypto.randomUUID && crypto.randomUUID()) || String(Math.random()).slice(2);
  const m = { id, kind, name:'', kana:'', dob:'', salary:0, other:0, disabled:'none', cohabit:true };
  members.push(m); renderMembers(); calcAll(false);
}
function removeMember(id){ members = members.filter(x=>x.id!==id); renderMembers(); calcAll(false); }
function onSpouseToggle(val){ if(val==='yes'){ if(!members.some(m=>m.kind==='é…å¶è€…')) addMember('é…å¶è€…'); } else { members = members.filter(m=>m.kind!=='é…å¶è€…'); renderMembers(); calcAll(false); } }
function onEdit(id,key,val){ const m = members.find(x=>x.id===id); if(!m) return; m[key]=val; calcAll(false); }

function renderMembers(){
  const wrap = $('#members'); wrap.innerHTML='';
  members.forEach((m,idx)=>{
    const div = document.createElement('div'); div.className='member';
    div.innerHTML = `
      <header><h3>${idx+1}. ${m.kind}</h3><button class="no-print" onclick="removeMember('${m.id}')">å‰Šé™¤</button></header>
      <div class="grid">
        <div class="field"><label>æ°å</label><input value="${m.name}" oninput="onEdit('${m.id}','name',this.value)"></div>
        <div class="field"><label>ãµã‚ŠãŒãª</label><input value="${m.kana}" oninput="onEdit('${m.id}','kana',this.value)"></div>
        <div class="field"><label>ç”Ÿå¹´æœˆæ—¥</label><input type="date" value="${m.dob}" oninput="onEdit('${m.id}','dob',this.value)"></div>
        <div class="field"><label>çµ¦ä¸åå…¥ï¼ˆè¦‹ç©ï¼‰</label>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input class="num" inputmode="numeric" value="${fmt(m.salary)}" oninput="onEdit('${m.id}','salary',parseNum(this.value))">
            <span class="inline-note">çµ¦ä¸æ‰€å¾—é‡‘é¡ï¼š<b class="mono" id="so_${m.id}">â€”</b></span>
          </div>
        </div>
        <div class="field"><label>çµ¦ä¸ä»¥å¤–ã®æ‰€å¾—</label><input class="num" inputmode="numeric" value="${fmt(m.other)}" oninput="onEdit('${m.id}','other',parseNum(this.value))"></div>
        <div class="field"><label>éšœå®³è€…åŒºåˆ†</label>
          <select oninput="onEdit('${m.id}','disabled',this.value)">
            <option ${m.disabled==='none'?'selected':''} value="none">è©²å½“ãªã—</option>
            <option ${m.disabled==='disabled'?'selected':''} value="disabled">éšœå®³è€…</option>
            <option ${m.disabled==='tokubetsu'?'selected':''} value="tokubetsu">ç‰¹åˆ¥éšœå®³è€…</option>
          </select>
        </div>
        <div class="field"><label>åŒå±…ï¼ˆä¸–å¸¯å†…ï¼‰</label>
          <select oninput="onEdit('${m.id}','cohabit',this.value==='true')">
            <option value="true" ${m.cohabit? 'selected':''}>ã¯ã„</option>
            <option value="false" ${!m.cohabit? 'selected':''}>ã„ã„ãˆ</option>
          </select>
        </div>
      </div>
      <div class="hint">çµ¦ä¸æ‰€å¾—æ§é™¤ï¼š<b class="mono" id="kj_${m.id}">â€”</b> ï¼ åˆè¨ˆæ‰€å¾—é‡‘é¡ï¼š<b class="mono" id="agi_${m.id}">â€”</b></div>
    `;
    wrap.appendChild(div);
  });
  attachComma();
}

/* ç¨è¨ˆç®—ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
function kyuyoShotokuKojo(s){
  s = Number(s||0);
  if(s<=0) return 0;
  if(s<=1625000) return 650000;
  if(s<=1800000) return Math.floor(s*0.4 - 100000);
  if(s<=3600000) return Math.floor(s*0.3 + 80000);
  if(s<=6600000) return Math.floor(s*0.2 + 440000);
  if(s<=8500000) return Math.floor(s*0.1 + 1100000);
  return 1950000;
}
function salaryToIncome(s){ return Math.max(0, Number(s||0) - kyuyoShotokuKojo(s)); }
function ageAt(dob){ if(!dob) return null; const dt=new Date(dob); if(isNaN(dt)) return null; const ref=new Date(new Date().getFullYear(),11,31); let a=ref.getFullYear()-dt.getFullYear(); const md=(ref.getMonth()-dt.getMonth())*100+(ref.getDate()-dt.getDate()); if(md<0) a--; return a; }
function agiOf(p){ return salaryToIncome(p.salary) + Number(p.other||0); }

/* åŸºç¤æ§é™¤ï¼ˆR7ï¼‰ */
function basicDeduction_ITax(agi){
  if(agi<=1320000) return 950000;      // 58ä¸‡+37ä¸‡
  if(agi<=3360000) return 880000;      // +30ä¸‡
  if(agi<=4890000) return 680000;      // +10ä¸‡
  if(agi<=6550000) return 630000;      // +5ä¸‡
  if(agi<=23500000) return 580000;
  if(agi<=24000000) return 320000;
  if(agi<=24500000) return 160000;
  if(agi<=25000000) return 0;
  return 0;
}
function basicDeduction_RTax(agi){
  if(agi<=24000000) return 430000;
  if(agi<=24500000) return 290000;
  if(agi<=25000000) return 150000;
  return 0;
}
function kubunI(agi){ if(agi<=9000000) return 'A'; if(agi<=9500000) return 'B'; if(agi<=10000000) return 'C'; return '-'; }

/* é…å¶è€…æ§é™¤ãƒ»ç‰¹åˆ¥æ§é™¤ï¼ˆè¦ç‚¹ã®ã¿ï¼‰ */
function spouseDeduction_ITax(tpAGI, spAGI, spAge){
  if(tpAGI>10000000) return 0; if(spAGI==null) return 0;
  if(spAGI<=580000){ const elderly=spAge>=70;
    if(tpAGI<=9000000) return elderly?480000:380000;
    if(tpAGI<=9500000) return elderly?320000:260000;
    return elderly?160000:130000;
  }
  return 0;
}
function spouseDeduction_RTax(tpAGI, spAGI, spAge){
  if(tpAGI>10000000) return 0; if(spAGI==null) return 0;
  if(spAGI<=580000){ const elderly=spAge>=70;
    if(tpAGI<=9000000) return elderly?380000:330000;
    if(tpAGI<=9500000) return elderly?260000:220000;
    return elderly?130000:110000;
  }
  return 0;
}
const pscBandsIT=[{min:580001,max:950000,vals:[380000,260000,130000]},{min:950001,max:1000000,vals:[360000,240000,120000]},{min:1000001,max:1050000,vals:[310000,210000,110000]},{min:1050001,max:1100000,vals:[260000,180000,90000]},{min:1100001,max:1150000,vals:[210000,140000,70000]},{min:1150001,max:1200000,vals:[160000,110000,60000]},{min:1200001,max:1250000,vals:[110000,80000,40000]},{min:1250001,max:1300000,vals:[60000,40000,20000]},{min:1300001,max:1330000,vals:[30000,20000,10000]}];
const pscBandsRT=[{min:580001,max:950000,vals:[330000,220000,110000]},{min:950001,max:1000000,vals:[330000,220000,110000]},{min:1000001,max:1050000,vals:[310000,210000,110000]},{min:1050001,max:1100000,vals:[260000,180000,90000]},{min:1100001,max:1150000,vals:[210000,140000,70000]},{min:1150001,max:1200000,vals:[160000,110000,60000]},{min:1200001,max:1250000,vals:[110000,80000,40000]},{min:1250001,max:1300000,vals:[60000,40000,20000]},{min:1300001,max:1330000,vals:[30000,20000,10000]}];
function spouseSpecial_ITax(tpAGI, spAGI){ if(tpAGI==null||spAGI==null) return 0; if(tpAGI>10000000) return 0; if(spAGI<=580000||spAGI>1330000) return 0; const col=tpAGI<=9000000?0:(tpAGI<=9500000?1:2); for(const b of pscBandsIT){ if(spAGI>=b.min&&spAGI<=b.max) return b.vals[col]; } return 0; }
function spouseSpecial_RTax(tpAGI, spAGI){ if(tpAGI==null||spAGI==null) return 0; if(tpAGI>10000000) return 0; if(spAGI<=580000||spAGI>1330000) return 0; const col=tpAGI<=9000000?0:(tpAGI<=9500000?1:2); for(const b of pscBandsRT){ if(spAGI>=b.min&&spAGI<=b.max) return b.vals[col]; } return 0; }

/* æ‰¶é¤Šæ§é™¤ãƒ»ç‰¹å®šè¦ªæ—ç‰¹åˆ¥æ§é™¤ãƒ»éšœå®³è€…æ§é™¤ */
function fuyou_ITax(age,dou){ if(age<16) return 0; if(age>=70) return dou?580000:480000; if(age>=19&&age<=22) return 630000; return 380000; }
function fuyou_RTax(age,dou){ if(age<16) return 0; if(age>=70) return dou?450000:380000; if(age>=19&&age<=22) return 450000; return 330000; }
function tokuteiRel_ITax(agi){ if(agi<=580000||agi>1230000) return 0; if(agi<=850000) return 630000; if(agi<=900000) return 610000; if(agi<=950000) return 510000; if(agi<=1000000) return 410000; if(agi<=1050000) return 310000; if(agi<=1100000) return 210000; if(agi<=1150000) return 110000; if(agi<=1200000) return 60000; return 30000; }
function tokuteiRel_RTax(agi){ if(agi<=580000||agi>1230000) return 0; if(agi<=950000) return 450000; if(agi<=1000000) return 410000; if(agi<=1050000) return 310000; if(agi<=1100000) return 210000; if(agi<=1150000) return 110000; if(agi<=1200000) return 60000; return 30000; }
function shogai_ITax(code){ if(code==='disabled') return 270000; if(code==='tokubetsu') return 400000; return 0; }
function shogai_RTax(code){ if(code==='disabled') return 260000; if(code==='tokubetsu') return 300000; return 0; }

/* æœ¬è¨ˆç®— */
function calcAll(){
  const you = {
    name:$('#youName').value.trim(), kana:$('#youKana').value.trim(),
    addr:$('#youAddr').value.trim(), dob:$('#youDOB').value,
    salary:parseNum($('#youSalary').value), other:parseNum($('#youOther').value),
    disabled:$('#youDis').value
  };
  const employer = $('#employer').value.trim();

  const youKJ = kyuyoShotokuKojo(you.salary);
  const youSO = salaryToIncome(you.salary);
  const youAGI = youSO + Number(you.other||0);
  $('#youKoujo').textContent = yen(youKJ);
  $('#youShotoku').textContent = yen(youSO);
  $('#youAGI').textContent = yen(youAGI);
  $('#youSalaryAfter').textContent = yen(youSO);
  $('#youBasicIT').textContent = yen(basicDeduction_ITax(youAGI));
  $('#youBasicRT').textContent = yen(basicDeduction_RTax(youAGI));

  members.forEach(m=>{
    const kj=kyuyoShotokuKojo(m.salary), so=salaryToIncome(m.salary), agi=agiOf(m);
    const kjEl=document.querySelector(`#kj_${m.id}`); if(kjEl) kjEl.textContent=yen(kj);
    const soEl=document.querySelector(`#so_${m.id}`); if(soEl) soEl.textContent=yen(so);
    const agiEl=document.querySelector(`#agi_${m.id}`); if(agiEl) agiEl.textContent=yen(agi);
  });

  let rows=[]; const push=(name,it,rt,memo='')=>rows.push({name,it,rt,memo});
  push('åŸºç¤æ§é™¤', basicDeduction_ITax(youAGI), basicDeduction_RTax(youAGI), `åŒºåˆ†â… ï¼š${kubunI(youAGI)}`);

  const spouse = members.find(m=>m.kind==='é…å¶è€…');
  let spAGI=null, spAge=0, spDis='none';
  if(spouse){ spAGI=agiOf(spouse); spAge=ageAt(spouse.dob)||0; spDis=spouse.disabled; }
  if(spouse){
    const it_sp=spouseDeduction_ITax(youAGI, spAGI, spAge), rt_sp=spouseDeduction_RTax(youAGI, spAGI, spAge);
    const it_spc=spouseSpecial_ITax(youAGI, spAGI), rt_spc=spouseSpecial_RTax(youAGI, spAGI);
    if(it_sp||rt_sp) push('é…å¶è€…æ§é™¤', it_sp, rt_sp, `é…å¶è€…AGIï¼š${yen(spAGI)}`);
    if(it_spc||rt_spc) push('é…å¶è€…ç‰¹åˆ¥æ§é™¤', it_spc, rt_spc, 'é…å¶è€…AGIå¸¯ã«è©²å½“');
    const it_spdis=shogai_ITax(spDis), rt_spdis=shogai_RTax(spDis); if(it_spdis||rt_spdis) push('éšœå®³è€…æ§é™¤ï¼ˆé…å¶è€…ï¼‰', it_spdis, rt_spdis, 'åŒä¸€ç”Ÿè¨ˆé…å¶è€…');
  }

  const deps = members.filter(m=>m.kind!=='é…å¶è€…');
  const fuyouList=[]; const tokuteiList=[];
  deps.forEach(m=>{
    const age=ageAt(m.dob)||0; const agi=agiOf(m);
    if(age>=16 && agi<=580000){ const it=fuyou_ITax(age, m.cohabit), rt=fuyou_RTax(age, m.cohabit); const note=(age>=70?(m.cohabit?'åŒå±…è€è¦ªç­‰':'è€äºº'):(age>=19&&age<=22?'ç‰¹å®šæ‰¶é¤Š':'ä¸€èˆ¬')); push(`æ‰¶é¤Šæ§é™¤ï¼ˆ${m.name||m.kind}ï¼‰`, it, rt, note); fuyouList.push({m,age,agi,note,it,rt}); }
    if(agi<=580000 && m.disabled!=='none'){ const it=shogai_ITax(m.disabled), rt=shogai_RTax(m.disabled); if(it||rt) push(`éšœå®³è€…æ§é™¤ï¼ˆ${m.name||m.kind}ï¼‰`, it, rt, 'æ‰¶é¤Šè¦ªæ—'); }
    if(age>=19 && age<=22 && agi>580000 && agi<=1230000){ const it=tokuteiRel_ITax(agi), rt=tokuteiRel_RTax(agi); push(`ç‰¹å®šè¦ªæ—ç‰¹åˆ¥æ§é™¤ï¼ˆ${m.name||m.kind}ï¼‰`, it, rt, `AGIï¼š${yen(agi)}`); tokuteiList.push({m,age,agi,it,rt}); }
  });

  const tbody=$('#tbody'); tbody.innerHTML='';
  rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.name}</td><td class="right mono">${yen(r.it)}</td><td class="right mono">${yen(r.rt)}</td><td>${r.memo||''}</td>`; tbody.appendChild(tr); });
  $('#sum_itax').textContent = yen(rows.reduce((a,b)=>a+b.it,0));
  $('#sum_rtax').textContent = yen(rows.reduce((a,b)=>a+b.rt,0));

  if(getComputedStyle($('#sheetPanel')).display!=='none') buildSheets({you, employer, youAGI, fuyouList, tokuteiList, spouse, spAGI, spAge, rows});
}

function buildSheets(ctx){
  const {you, employer, youAGI, fuyouList, tokuteiList, spouse, spAGI, spAge} = ctx;
  const sheet = $('#sheet'); sheet.innerHTML='';
  const title = document.createElement('div'); title.className='title';
  title.innerHTML = `<h2>ä»¤å’Œ7å¹´åˆ†  åŸºç¤æ§é™¤ãƒ»é…å¶è€…æ§é™¤ç­‰ãƒ»ç‰¹å®šè¦ªæ—ç‰¹åˆ¥æ§é™¤ãƒ»æ‰€å¾—é‡‘é¡èª¿æ•´æ§é™¤ï¼æ‰¶é¤Šæ§é™¤ç­‰ï¼ˆç•°å‹•ï¼‰ç”³å‘Šæ›¸ï¼ˆä¸‹æ›¸ãï¼‰</h2><div class="subtle">å‹¤å‹™å…ˆï¼š${escapeHtml(employer)||'â€”'}</div>`;
  sheet.appendChild(title);

  const grid = document.createElement('div'); grid.className='grid-2';

  const b1=document.createElement('div'); b1.className='box';
  b1.innerHTML=`<h4>â—† çµ¦ä¸æ‰€å¾—è€…ã®åŸºç¤æ§é™¤ç”³å‘Šæ›¸</h4>
  <div class="kv">
    <div>æ°åï¼ˆãƒ•ãƒªã‚¬ãƒŠï¼‰</div><div><b>${escapeHtml(you.name)||'â€”'}</b>ï¼ˆ${escapeHtml(you.kana)||'â€”'}ï¼‰</div>
    <div>ä½æ‰€</div><div>${escapeHtml(you.addr)||'â€”'}</div>
    <div>ç”Ÿå¹´æœˆæ—¥</div><div>${you.dob||'â€”'}</div>
    <div>åˆè¨ˆæ‰€å¾—é‡‘é¡ã®è¦‹ç©é¡</div><div class="mono">${yen(youAGI)}</div>
    <div>åŒºåˆ†â… ï¼ˆA/B/Cï¼‰</div><div class="mono">${kubunI(youAGI)}</div>
    <div>åŸºç¤æ§é™¤ï¼ˆæ‰€å¾—ç¨/ä½æ°‘ç¨ï¼‰</div><div class="mono">${yen(basicDeduction_ITax(youAGI))} / ${yen(basicDeduction_RTax(youAGI))}</div>
  </div>`;

  const b2=document.createElement('div'); b2.className='box';
  let spHtml = '<div class="kv"><div>é…å¶è€…</div><div>â€”</div></div>';
  if(spouse){
    const it=spouseDeduction_ITax(youAGI, spAGI, spAge), rt=spouseDeduction_RTax(youAGI, spAGI, spAge), it2=spouseSpecial_ITax(youAGI, spAGI), rt2=spouseSpecial_RTax(youAGI, spAGI);
    spHtml = `<div class="kv">
      <div>é…å¶è€…æ°åï¼ˆãƒ•ãƒªã‚¬ãƒŠï¼‰</div><div><b>${escapeHtml(spouse.name)||'â€”'}</b>ï¼ˆ${escapeHtml(spouse.kana)||'â€”'}ï¼‰</div>
      <div>ç”Ÿå¹´æœˆæ—¥</div><div>${spouse.dob||'â€”'}ï¼ˆå¹´é½¢ï¼š${spAge??'â€”'}ï¼‰</div>
      <div>é…å¶è€…ã®åˆè¨ˆæ‰€å¾—è¦‹ç©é¡</div><div class="mono">${yen(spAGI)}</div>
      <div>æ§é™¤é¡ï¼ˆå‚è€ƒï¼šæ‰€å¾—ç¨/ä½æ°‘ç¨ï¼‰</div><div class="mono">${yen(it||it2)} / ${yen(rt||rt2)}</div>
    </div>`;
  }
  b2.innerHTML = `<h4>â—† çµ¦ä¸æ‰€å¾—è€…ã®é…å¶è€…æ§é™¤ç­‰ç”³å‘Šæ›¸</h4>${spHtml}`;

  const b3=document.createElement('div'); b3.className='box';
  b3.innerHTML = `<h4>â—† çµ¦ä¸æ‰€å¾—è€…ã®ç‰¹å®šè¦ªæ—ç‰¹åˆ¥æ§é™¤ç”³å‘Šæ›¸</h4>
  <table style="width:100%;border-collapse:collapse"><thead><tr><th>ç‰¹å®šè¦ªæ—ã®æ°å</th><th>å¹´é½¢</th><th>åˆè¨ˆæ‰€å¾—</th><th>æ§é™¤é¡ï¼ˆæ‰€å¾—ç¨/ä½æ°‘ç¨ï¼‰</th></tr></thead><tbody>
    ${tokuteiList.map(r=>`<tr><td>${escapeHtml(r.m.name)||'-'}</td><td>${r.age}</td><td class="mono">${yen(r.agi)}</td><td class="mono">${yen(r.it)} / ${yen(r.rt)}</td></tr>`).join('')||'<tr><td colspan="4">è©²å½“ãªã—</td></tr>'}
  </tbody></table>`;

  const b5=document.createElement('div'); b5.className='box';
  b5.innerHTML = `<h4>â—† æ‰¶é¤Šæ§é™¤ç­‰ï¼ˆç•°å‹•ï¼‰ç”³å‘Šæ›¸ï¼ˆæ§é™¤å¯¾è±¡æ‰¶é¤Šè¦ªæ—ï¼‰</h4>
  <table style="width:100%;border-collapse:collapse"><thead><tr><th>æ°å</th><th>ç”Ÿå¹´æœˆæ—¥</th><th>ç¶šæŸ„</th><th>åŒºåˆ†</th><th>åˆè¨ˆæ‰€å¾—</th></tr></thead><tbody>
    ${ctx.fuyouList.map(r=>`<tr><td>${escapeHtml(r.m.name)||'-'}</td><td>${r.m.dob||'-'}</td><td>${r.m.kind}</td><td>${escapeHtml(r.note)}</td><td class="mono">${yen(r.agi)}</td></tr>`).join('')||'<tr><td colspan="5">è©²å½“ãªã—</td></tr>'}
  </tbody></table>`;

  grid.append(b1,b2,b3,b5);
  sheet.appendChild(grid);
}

function toggleSheet(){
  const p = document.getElementById('sheetPanel');
  const btn = document.getElementById('toggleSheetBtn');
  const now = getComputedStyle(p).display;
  p.style.display = (now==='none')? 'block':'none';
  if(btn) btn.textContent = (p.style.display==='block')? 'è»¢è¨˜ã‚·ãƒ¼ãƒˆã‚’éš ã™':'è»¢è¨˜ã‚·ãƒ¼ãƒˆã‚’è¡¨ç¤º';
  if(p.style.display==='block') calcAll();
}
function exportPDF(){
  const s = document.getElementById('sheet');
  if(!s){ alert('è»¢è¨˜ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  const w = window.open('', '_blank');
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>è»¢è¨˜ã‚·ãƒ¼ãƒˆPDF</title><style>@page{size:A4 landscape;margin:10mm}body{font:12px/1.4 system-ui} .sheet{border:none} .box{border:1px solid #000;padding:8px} table{border-collapse:collapse;width:100%} th,td{border:1px solid #000;padding:4px 6px;text-align:left}</style></head><body>${s.outerHTML}<script>window.onload=()=>window.print()</script></body></html>`);
  w.document.close();
}
function resetAll(){
  if(!confirm('å…¥åŠ›å†…å®¹ã‚’ã™ã¹ã¦åˆæœŸåŒ–ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  $('#employer').value=''; $('#youName').value=''; $('#youKana').value=''; $('#youAddr').value=''; $('#youDOB').value='';
  $('#youSalary').value=''; $('#youOther').value='0'; $('#youDis').value='none'; $('#hasSpouse').value='no';
  members=[]; renderMembers(); attachComma(); calcAll();
}
function escapeHtml(s){ if(!s&&s!==0) return ''; return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

/* åˆæœŸåŒ– */
attachComma();
calcAll();
</script>
</body>
</html>
