<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>人的控除アプリ r5（控除額テーブル＋ワンクリック転記シート）</title>
<style>
  :root{--ink:#0f172a;--muted:#64748b;--bg:#f8fafc;--accent:#0ea5e9;--border:#e5e7eb;--solid:#0f172a}
  html,body{margin:0;padding:0;color:var(--ink);font:14px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:#fff}
  header{position:sticky;top:0;background:#fff;z-index:5;border-bottom:1px solid var(--border)}
  header .bar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 14px}
  header h1{font-size:16px;margin:0}
  main{display:grid;grid-template-columns: 360px 1fr;gap:14px;padding:14px}
  .panel{border:1px solid var(--border);border-radius:12px;background:#fff}
  .panel h2{font-size:15px;margin:0;padding:12px 14px;border-bottom:1px solid var(--border)}
  .panel .content{padding:12px 14px}
  .row{display:grid;grid-template-columns: 1fr 1fr;gap:8px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:12px;color:var(--muted)}
  .field input, .field select{padding:8px;border:1px solid var(--border);border-radius:8px;font-size:14px}
  .muted{color:var(--muted)}
  button{appearance:none;border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
  button.primary{background:var(--accent);color:#fff;border-color:transparent}
  .members{display:flex;flex-direction:column;gap:10px}
  .member{border:1px dashed var(--border);border-radius:10px;padding:10px}
  .member header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .member h3{font-size:14px;margin:0}
  .member .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .hint{font-size:12px;color:var(--muted)}

  /* 結果 */
  .results{margin-top:6px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--border);padding:6px 8px;text-align:left}
  tfoot td{font-weight:700}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .right{text-align:right}
  .ok{color:#059669}
  .ng{color:#b91c1c}

  /* 転記シート（A4横） */
  .sheetWrap{display:none;margin-top:12px}
  .sheet{--gap:8px;background:#fff;border:2px solid #000;border-radius:0;padding:8px;display:grid;gap:8px}
  .sheet .title{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #000;padding-bottom:6px}
  .sheet h2{font-size:16px;margin:0}
  .sheet .grid-2{display:grid;grid-template-columns: 1fr 1fr;gap:8px}
  .box{border:1px solid #000;padding:8px}
  .box h4{margin:0 0 6px 0;font-size:13px}
  .kv{display:grid;grid-template-columns: 240px 1fr;gap:6px}

  .badge{font-size:11px;border:1px solid #000;padding:2px 6px;display:inline-block}
  .subtle{color:#444}

  .print-bar{display:flex;gap:8px;align-items:center}
  @media print{@page{size:A4 landscape;margin:10mm} header,.no-print{display:none !important} main{display:block;padding:0} .sheet{border:none}}
</style>
</head>
<body>
  <header>
    <div class="bar">
      <h1>人的控除アプリ r5（控除額テーブル＋ワンクリック転記シート）</h1>
      <div class="print-bar no-print">
        <button onclick="calcAll()">控除額を計算</button>
        <button id="toggleSheetBtn" class="primary" onclick="toggleSheet()">転記シートを表示</button>
        <button onclick="window.print()">A4横で印刷</button>
      </div>
    </div>
  </header>

  <main>
    <!-- 左：入力 -->
    <section class="panel">
      <h2>① 世帯・本人情報</h2>
      <div class="content">
        <div class="field"><label>給与の支払者（勤務先名）</label><input id="employer" placeholder="○○株式会社"/></div>
        <div class="field"><label>あなたの氏名（本人）</label><input id="youName" placeholder="山田 太郎"/></div>
        <div class="row">
          <div class="field"><label>あなたのふりがな</label><input id="youKana" placeholder="ヤマダ タロウ"/></div>
          <div class="field"><label>あなたの住所</label><input id="youAddr" placeholder="東京都○○区…"/></div>
        </div>
        <div class="row">
          <div class="field"><label>あなたの生年月日</label><input id="youDOB" type="date"/></div>
          <div class="field"><label>あなたの給与収入（見積）</label><input id="youSalary" class="num" inputmode="numeric" placeholder="例 5,500,000"/></div>
        </div>
        <div class="row">
          <div class="field"><label>あなたの給与以外の所得（見積）</label><input id="youOther" class="num" inputmode="numeric" value="0"/></div>
          <div class="field"><label>障害者区分</label>
            <select id="youDis">
              <option value="none">該当なし</option>
              <option value="disabled">障害者</option>
              <option value="tokubetsu">特別障害者</option>
            </select>
          </div>
        </div>
        <p class="muted">給与収入を入れると、以下が自動表示されます：
          <br>・<b>給与所得控除</b>　・<b>給与所得金額</b>　・<b>合計所得金額</b>
        </p>
        <div class="box" style="border:1px solid var(--border);border-radius:10px;padding:8px">
          <div class="row">
            <div>給与所得控除：<b class="mono" id="youKoujo">—</b></div>
            <div>給与所得金額：<b class="mono" id="youShotoku">—</b></div>
          </div>
          <div>合計所得金額（見積）：<b class="mono" id="youAGI">—</b></div>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>② 家族情報（配偶者・扶養親族等）</h2>
      <div class="content">
        <div class="members" id="members"></div>
        <div class="no-print" style="margin-top:8px;display:flex;gap:8px">
          <button onclick="addMember('配偶者')">配偶者を追加</button>
          <button onclick="addMember('子')">子を追加</button>
          <button onclick="addMember('その他親族')">その他親族を追加</button>
        </div>
        <p class="hint">※ 数字入力は<b>リアルタイムでカンマ表示</b>されます（内部は数値で計算）。給与収入の入力で<b>給与所得控除・給与所得金額</b>も即時計算・表示します。</p>
      </div>
    </section>

    <!-- 右：控除額テーブル＆転記シート -->
    <section class="panel" style="grid-column: 1 / -1">
      <h2>③ 控除額テーブル</h2>
      <div class="content">
        <table id="resultTbl">
          <thead><tr><th>区分</th><th class="right">所得税</th><th class="right">住民税</th><th>メモ</th></tr></thead>
          <tbody id="tbody"></tbody>
          <tfoot><tr><td>合計</td><td id="sum_itax" class="right">—</td><td id="sum_rtax" class="right">—</td><td></td></tr></tfoot>
        </table>
      </div>
    </section>

    <section class="panel sheetWrap" id="sheetWrap" style="grid-column: 1 / -1">
      <h2>④ 転記シート（ボタンで表示／A4横）</h2>
      <div class="content">
        <div class="sheet" id="sheet"></div>
        <p class="hint">・様式：<b>基礎控除申告書／配偶者控除等申告書／特定親族特別控除申告書／所得金額調整控除申告書</b>（2025bun_06）に沿った項目を配置。<br>・あわせて<b>扶養控除等（異動）申告書</b>の転記欄も用意しました（控除対象扶養親族のみ抽出）。</p>
      </div>
    </section>
  </main>

<script>
// ====== 数値ユーティリティ（カンマ表示） ======
const numEls = () => Array.from(document.querySelectorAll('input.num'));
const fmt = (n) => (n===null||n===undefined||isNaN(n)? '—' : Number(n).toLocaleString('ja-JP'));
const parseNum = (v) => { if(v===undefined||v===null) return 0; return Number(String(v).replace(/[^\d.-]/g,'')||0); };
function attachComma(){
  numEls().forEach(el=>{
    el.addEventListener('input', (e)=>{
      const raw = parseNum(el.value);
      el.value = raw.toLocaleString('ja-JP');
      calcAll(false); // 軽い再計算（リアルタイム）
    });
  });
}

// ====== データモデル ======
const $ = (s)=>document.querySelector(s);
let members = [];
function addMember(kind){
  const id = crypto.randomUUID();
  const m = { id, kind, name:"", kana:"", dob:"", salary:0, other:0, disabled:"none", cohabit:true };
  members.push(m); renderMembers(); calcAll(false);
}
function removeMember(id){ members = members.filter(x=>x.id!==id); renderMembers(); calcAll(false); }
function onEdit(id,key,val){ const m = members.find(x=>x.id===id); if(!m) return; m[key]=val; calcAll(false); }

function renderMembers(){
  const wrap = $('#members'); wrap.innerHTML='';
  members.forEach((m,idx)=>{
    const div = document.createElement('div'); div.className='member';
    div.innerHTML = `
      <header><h3>${idx+1}. ${m.kind}</h3><button class="no-print" onclick="removeMember('${m.id}')">削除</button></header>
      <div class="grid">
        <div class="field"><label>氏名</label><input value="${m.name}" oninput="onEdit('${m.id}','name',this.value)"/></div>
        <div class="field"><label>ふりがな</label><input value="${m.kana}" oninput="onEdit('${m.id}','kana',this.value)"/></div>
        <div class="field"><label>生年月日</label><input type="date" value="${m.dob}" oninput="onEdit('${m.id}','dob',this.value)"/></div>
        <div class="field"><label>給与収入（見積）</label><input class="num" inputmode="numeric" value="${fmt(m.salary)}" oninput="onEdit('${m.id}','salary',parseNum(this.value))"/></div>
        <div class="field"><label>給与以外の所得</label><input class="num" inputmode="numeric" value="${fmt(m.other)}" oninput="onEdit('${m.id}','other',parseNum(this.value))"/></div>
        <div class="field"><label>障害者区分</label>
          <select oninput="onEdit('${m.id}','disabled',this.value)">
            <option ${m.disabled==='none'?'selected':''} value="none">該当なし</option>
            <option ${m.disabled==='disabled'?'selected':''} value="disabled">障害者</option>
            <option ${m.disabled==='tokubetsu'?'selected':''} value="tokubetsu">特別障害者</option>
          </select>
        </div>
        <div class="field"><label>同居（世帯内）</label>
          <select oninput="onEdit('${m.id}','cohabit',this.value==='true')">
            <option value="true" ${m.cohabit? 'selected':''}>はい</option>
            <option value="false" ${!m.cohabit? 'selected':''}>いいえ</option>
          </select>
        </div>
      </div>
      <div class="hint">給与所得控除：<b class="mono" id="kj_${m.id}">—</b> ／ 給与所得金額：<b class="mono" id="so_${m.id}">—</b> ／ 合計所得金額：<b class="mono" id="agi_${m.id}">—</b></div>
    `;
    wrap.appendChild(div);
  });
  attachComma();
}

// ====== 計算ユーティリティ ======
// 給与所得控除（R7：最低保障65万、～180万：40%-10万、～190万：30%+8万、190万超は従前）
function kyuyoShotokuKojo(s){
  s = Number(s||0);
  if(s<=0) return 0;
  if(s <= 1625000) return 650000;
  if(s <= 1800000) return Math.floor(s*0.4 - 100000);
  if(s <= 1900000) return Math.floor(s*0.3 + 80000);
  if(s <= 3600000) return Math.floor(s*0.3 + 80000);
  if(s <= 6600000) return Math.floor(s*0.2 + 440000);
  if(s <= 8500000) return Math.floor(s*0.1 + 1100000);
  return 1950000;
}
function salaryToIncome(s){ return Math.max(0, Number(s||0) - kyuyoShotokuKojo(s)); }
function ageAt(dob){ if(!dob) return null; const dt=new Date(dob); if(isNaN(dt)) return null; const ref=new Date(new Date().getFullYear(),11,31); let a=ref.getFullYear()-dt.getFullYear(); const md=(ref.getMonth()-dt.getMonth())*100+(ref.getDate()-dt.getDate()); if(md<0) a--; return a; }
function agiOf(p){ return salaryToIncome(p.salary) + Number(p.other||0); }
function yen(n){ return '¥'+fmt(n); }

// 基礎控除（R7）
function basicDeduction_ITax(agi){
  if(agi<=1320000) return 950000; if(agi<=3360000) return 880000; if(agi<=4890000) return 680000; if(agi<=6550000) return 630000; if(agi<=23500000) return 580000; if(agi<=24000000) return 480000; if(agi<=24500000) return 320000; if(agi<=25000000) return 160000; return 0;
}
function basicDeduction_RTax(agi){ if(agi<=24000000) return 430000; if(agi<=24500000) return 290000; if(agi<=25000000) return 150000; return 0; }
function kubunI(agi){ if(agi<=9000000) return 'A'; if(agi<=9500000) return 'B'; if(agi<=10000000) return 'C'; return '-'; }

// 配偶者（控除/特別）
function spouseDeduction_ITax(tpAGI, spAGI, spAge){ if(tpAGI>10000000) return 0; if(spAGI==null) return 0; if(spAGI<=580000){ const elderly=spAge>=70; if(tpAGI<=9000000) return elderly?480000:380000; if(tpAGI<=9500000) return elderly?320000:260000; return elderly?160000:130000; } return 0; }
function spouseDeduction_RTax(tpAGI, spAGI, spAge){ if(tpAGI>10000000) return 0; if(spAGI==null) return 0; if(spAGI<=580000){ const elderly=spAge>=70; if(tpAGI<=9000000) return elderly?380000:330000; if(tpAGI<=9500000) return elderly?260000:220000; return elderly?130000:110000; } return 0; }
const pscBandsIT = [ {min:580001,max:950000,vals:[380000,260000,130000]}, {min:950001,max:1000000,vals:[360000,240000,120000]}, {min:1000001,max:1050000,vals:[310000,210000,110000]}, {min:1050001,max:1100000,vals:[260000,180000,90000]}, {min:1100001,max:1150000,vals:[210000,140000,70000]}, {min:1150001,max:1200000,vals:[160000,110000,60000]}, {min:1200001,max:1250000,vals:[110000,80000,40000]}, {min:1250001,max:1300000,vals:[60000,40000,20000]}, {min:1300001,max:1330000,vals:[30000,20000,10000]}, ];
const pscBandsRT = [ {min:580001,max:950000,vals:[330000,220000,110000]}, {min:950001,max:1000000,vals:[330000,220000,110000]}, {min:1000001,max:1050000,vals:[310000,210000,110000]}, {min:1050001,max:1100000,vals:[260000,180000,90000]}, {min:1100001,max:1150000,vals:[210000,140000,70000]}, {min:1150001,max:1200000,vals:[160000,110000,60000]}, {min:1200001,max:1250000,vals:[110000,80000,40000]}, {min:1250001,max:1300000,vals:[60000,40000,20000]}, {min:1300001,max:1330000,vals:[30000,20000,10000]}, ];
function spouseSpecial_ITax(tpAGI, spAGI){ if(tpAGI==null||spAGI==null) return 0; if(tpAGI>10000000) return 0; if(spAGI<=580000||spAGI>1330000) return 0; const col=tpAGI<=9000000?0:(tpAGI<=9500000?1:2); for(const b of pscBandsIT){ if(spAGI>=b.min&&spAGI<=b.max) return b.vals[col]; } return 0; }
function spouseSpecial_RTax(tpAGI, spAGI){ if(tpAGI==null||spAGI==null) return 0; if(tpAGI>10000000) return 0; if(spAGI<=580000||spAGI>1330000) return 0; const col=tpAGI<=9000000?0:(tpAGI<=9500000?1:2); for(const b of pscBandsRT){ if(spAGI>=b.min&&spAGI<=b.max) return b.vals[col]; } return 0; }

// 扶養控除
function fuyou_ITax(age, dou){ if(age<16) return 0; if(age>=70) return dou?580000:480000; if(age>=19 && age<=22) return 630000; return 380000; }
function fuyou_RTax(age, dou){ if(age<16) return 0; if(age>=70) return dou?450000:380000; if(age>=19 && age<=22) return 450000; return 330000; }

// 特定親族特別控除（所得税/住民税）
function tokuteiRel_ITax(agi){ if(agi<=580000||agi>1230000) return 0; if(agi<=850000) return 630000; if(agi<=900000) return 610000; if(agi<=950000) return 510000; if(agi<=1000000) return 410000; if(agi<=1050000) return 310000; if(agi<=1100000) return 210000; if(agi<=1150000) return 110000; if(agi<=1200000) return 60000; return 30000; }
function tokuteiRel_RTax(agi){ if(agi<=580000||agi>1230000) return 0; if(agi<=950000) return 450000; if(agi<=1000000) return 410000; if(agi<=1050000) return 310000; if(agi<=1100000) return 210000; if(agi<=1150000) return 110000; if(agi<=1200000) return 60000; return 30000; }

// 障害者控除（簡易）
function shogai_ITax(code){ if(code==='disabled') return 270000; if(code==='tokubetsu') return 400000; return 0; }
function shogai_RTax(code){ if(code==='disabled') return 260000; if(code==='tokubetsu') return 300000; return 0; }

// ====== 計算コア ======
function calcAll(showMessage=true){
  // 本人
  const you = { name:$('#youName').value.trim(), kana:$('#youKana').value.trim(), addr:$('#youAddr').value.trim(), dob:$('#youDOB').value, salary:parseNum($('#youSalary').value), other:parseNum($('#youOther').value), disabled:$('#youDis').value };
  const employer = $('#employer').value.trim();
  const youKJ = kyuyoShotokuKojo(you.salary);
  const youSO = salaryToIncome(you.salary);
  const youAGI = youSO + Number(you.other||0);
  $('#youKoujo').textContent = yen(youKJ); $('#youShotoku').textContent = yen(youSO); $('#youAGI').textContent = yen(youAGI);

  // メンバーの付帯表示
  members.forEach(m=>{ const kj=kyuyoShotokuKojo(m.salary); const so=salaryToIncome(m.salary); const agi=agiOf(m); const a=ageAt(m.dob); const pre=`#`; const kjEl=document.querySelector(`#kj_${m.id}`); if(kjEl) kjEl.textContent=yen(kj); const soEl=document.querySelector(`#so_${m.id}`); if(soEl) soEl.textContent=yen(so); const agiEl=document.querySelector(`#agi_${m.id}`); if(agiEl) agiEl.textContent=yen(agi); });

  // ① 基礎控除
  let rows=[]; let itSum=0, rtSum=0; const push=(name,it,rt,memo='')=>{ itSum+=it; rtSum+=rt; rows.push({name,it,rt,memo}); };
  push('基礎控除', basicDeduction_ITax(youAGI), basicDeduction_RTax(youAGI), `区分Ⅰ：${kubunI(youAGI)}`);

  // ② 配偶者（1人まで想定）
  const spouse = members.find(m=>m.kind==='配偶者');
  let spAGI=null, spAge=0, spDis='none';
  if(spouse){ spAGI=agiOf(spouse); spAge=ageAt(spouse.dob)||0; spDis=spouse.disabled; }
  if(spouse){
    const it_sp = spouseDeduction_ITax(youAGI, spAGI, spAge); const rt_sp = spouseDeduction_RTax(youAGI, spAGI, spAge);
    const it_spc= spouseSpecial_ITax(youAGI, spAGI); const rt_spc= spouseSpecial_RTax(youAGI, spAGI);
    if(it_sp||rt_sp) push('配偶者控除', it_sp, rt_sp, `配偶者AGI：${yen(spAGI)}`);
    if(it_spc||rt_spc) push('配偶者特別控除', it_spc, rt_spc, `配偶者AGI帯に該当`);
    const it_spdis=shogai_ITax(spDis), rt_spdis=shogai_RTax(spDis); if(it_spdis||rt_spdis) push('障害者控除（配偶者）', it_spdis, rt_spdis, '同一生計配偶者');
  }

  // ③ 扶養控除・特定親族特別控除・障害者控除（親族）
  const deps = members.filter(m=>m.kind!=='配偶者');
  const fuyouList = [];
  const tokuteiList = [];
  deps.forEach(m=>{
    const age=ageAt(m.dob)||0; const agi=agiOf(m);
    // 扶養控除（年齢>=16 かつ AGI<=58万）
    if(age>=16 && agi<=580000){ const it=fuyou_ITax(age, m.cohabit); const rt=fuyou_RTax(age, m.cohabit); const note=(age>=70? (m.cohabit?'同居老親等':'老人') : (age>=19&&age<=22?'特定扶養':'一般')); push(`扶養控除（${m.name||m.kind}）`, it, rt, note); fuyouList.push({m,age,agi,note,it,rt}); }
    // 障害者控除（親族）：同一生計かつAGI<=58万
    if(agi<=580000 && m.disabled!=='none'){ const it=shogai_ITax(m.disabled), rt=shogai_RTax(m.disabled); if(it||rt) push(`障害者控除（${m.name||m.kind}）`, it, rt, '扶養親族'); }
    // 特定親族特別控除（19～22歳、AGI58万超～123万以下）
    if(age>=19 && age<=22 && agi>580000 && agi<=1230000){ const it=tokuteiRel_ITax(agi); const rt=tokuteiRel_RTax(agi); push(`特定親族特別控除（${m.name||m.kind}）`, it, rt, `AGI：${yen(agi)}`); tokuteiList.push({m,age,agi,it,rt}); }
  });

  // ④ 本人の障害者控除（任意）
  if(you.disabled!=='none'){ const it=shogai_ITax(you.disabled), rt=shogai_RTax(you.disabled); if(it||rt) push('障害者控除（本人）', it, rt, '本人分'); }

  // 出力
  const tbody=$('#tbody'); tbody.innerHTML='';
  rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.name}</td><td class="right mono">${yen(r.it)}</td><td class="right mono">${yen(r.rt)}</td><td>${r.memo||''}</td>`; tbody.appendChild(tr); });
  $('#sum_itax').textContent = yen(rows.reduce((a,b)=>a+b.it,0));
  $('#sum_rtax').textContent = yen(rows.reduce((a,b)=>a+b.rt,0));

  // 転記シートを再構築（必要時）
  if(document.querySelector('#sheetWrap').style.display!=='none') buildSheets({you, employer, youAGI, fuyouList, tokuteiList, spouse, spAGI, spAge, rows});
}

function buildSheets(ctx){
  const {you, employer, youAGI, fuyouList, tokuteiList, spouse, spAGI, spAge, rows} = ctx;
  const sheet = $('#sheet'); sheet.innerHTML='';
  const title = document.createElement('div'); title.className='title';
  title.innerHTML = `<h2>令和7年分  基礎控除・配偶者控除等・特定親族特別控除・所得金額調整控除／扶養控除等（異動）申告書（下書き）</h2><div class="subtle">勤務先：${escapeHtml(employer)||'—'}</div>`; sheet.appendChild(title);

  const grid = document.createElement('div'); grid.className='grid-2';

  // ◆ 基礎控除申告書
  const b1=document.createElement('div'); b1.className='box'; b1.innerHTML=`<h4>◆ 給与所得者の基礎控除申告書</h4><div class="kv"><div>氏名（フリガナ）</div><div><b>${escapeHtml(you.name)||'—'}</b>（${escapeHtml(you.kana)||'—'}）</div><div>住所</div><div>${escapeHtml(you.addr)||'—'}</div><div>生年月日</div><div>${you.dob||'—'}</div><div>合計所得金額の見積額</div><div class="mono">${yen(youAGI)}</div><div>区分Ⅰ（A/B/C）</div><div class="mono">${kubunI(youAGI)}</div><div>基礎控除額（参考）</div><div class="mono">${yen(basicDeduction_ITax(youAGI))}</div></div>`;

  // ◆ 配偶者控除等申告書
  const b2=document.createElement('div'); b2.className='box';
  let spHtml = '<div class="kv"><div>配偶者</div><div>—</div></div>';
  if(spouse){ const it=spouseDeduction_ITax(youAGI, spAGI, spAge), rt=spouseDeduction_RTax(youAGI, spAGI, spAge), it2=spouseSpecial_ITax(youAGI, spAGI), rt2=spouseSpecial_RTax(youAGI, spAGI); spHtml = `<div class="kv"><div>配偶者氏名（フリガナ）</div><div><b>${escapeHtml(spouse.name)||'—'}</b>（${escapeHtml(spouse.kana)||'—'}）</div><div>生年月日</div><div>${spouse.dob||'—'}（年齢：${spAge??'—'}）</div><div>配偶者の合計所得見積額</div><div class="mono">${yen(spAGI)}</div><div>控除額（参考）</div><div class="mono">${yen(it||it2)} / ${yen(rt||rt2)}</div></div>`; }
  b2.innerHTML = `<h4>◆ 給与所得者の配偶者控除等申告書</h4>${spHtml}`;

  // ◆ 特定親族特別控除申告書
  const b3=document.createElement('div'); b3.className='box';
  b3.innerHTML = `<h4>◆ 給与所得者の特定親族特別控除申告書</h4>
    <table style="width:100%;border-collapse:collapse"><thead><tr><th>特定親族の氏名</th><th>年齢</th><th>合計所得</th><th>控除額（所得税/住民税）</th></tr></thead><tbody>
      ${tokuteiList.map(r=>`<tr><td>${escapeHtml(r.m.name)||'-'}</td><td>${r.age}</td><td class="mono">${yen(r.agi)}</td><td class="mono">${yen(r.it)} / ${yen(r.rt)}</td></tr>`).join('')||'<tr><td colspan="4">該当なし</td></tr>'}
    </tbody></table>`;

  // ◆ 所得金額調整控除（簡易）
  const b4=document.createElement('div'); b4.className='box'; b4.innerHTML = `<h4>◆ 所得金額調整控除申告書（下書き）</h4><div class="kv"><div>要件</div><div>（※該当の有無は源泉事務で最終判定）</div><div>控除額（参考）</div><div class="mono">—</div></div>`;

  grid.append(b1,b2);

  // ◆ 扶養控除等（異動）申告書（控除対象扶養親族のみ）
  const b5=document.createElement('div'); b5.className='box';
  b5.innerHTML = `<h4>◆ 扶養控除等（異動）申告書（控除対象扶養親族）</h4>
    <table style="width:100%;border-collapse:collapse"><thead><tr><th>氏名</th><th>生年月日</th><th>続柄</th><th>区分</th><th>合計所得</th></tr></thead><tbody>
      ${fuyouList.map(r=>`<tr><td>${escapeHtml(r.m.name)||'-'}</td><td>${r.m.dob||'-'}</td><td>${r.m.kind}</td><td>${escapeHtml(r.note)}</td><td class="mono">${yen(r.agi)}</td></tr>`).join('')||'<tr><td colspan="5">該当なし</td></tr>'}
    </tbody></table>`;

  grid.append(b3,b5);
  sheet.appendChild(grid);
}

function toggleSheet(){ const wrap=$('#sheetWrap'); if(wrap.style.display==='none'||!wrap.style.display){ wrap.style.display='block'; calcAll(false); $('#toggleSheetBtn').textContent='転記シートを隠す'; } else { wrap.style.display='none'; $('#toggleSheetBtn').textContent='転記シートを表示'; } }

function escapeHtml(s){ if(!s&&s!==0) return ''; return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

// 初期化
addMember('配偶者'); addMember('子'); attachComma();
// 初回軽計算
calcAll(false);
</script>
</body>
</html>
